<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- saved from url=(0059)https://docs.openstack.org/developer/taskflow/examples.html -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    
    <title>Hello world — taskflow 2.9.1.dev11 documentation</title>
    
    <link rel="stylesheet" href="./Hello world — taskflow 2.9.1.dev11 documentation_files/nature.css" type="text/css">
    <link rel="stylesheet" href="./Hello world — taskflow 2.9.1.dev11 documentation_files/pygments.css" type="text/css">
    <link rel="stylesheet" href="./Hello world — taskflow 2.9.1.dev11 documentation_files/tweaks.css" type="text/css">
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '2.9.1.dev11',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="./Hello world — taskflow 2.9.1.dev11 documentation_files/jquery.js.下载"></script>
    <script type="text/javascript" src="./Hello world — taskflow 2.9.1.dev11 documentation_files/underscore.js.下载"></script>
    <script type="text/javascript" src="./Hello world — taskflow 2.9.1.dev11 documentation_files/doctools.js.下载"></script>
    <link rel="index" title="Index" href="https://docs.openstack.org/developer/taskflow/genindex.html">
    <link rel="search" title="Search" href="https://docs.openstack.org/developer/taskflow/search.html">
    <link rel="next" title="Exceptions" href="https://docs.openstack.org/developer/taskflow/exceptions.html">
    <link rel="prev" title="Conductors" href="https://docs.openstack.org/developer/taskflow/conductors.html"> 
  </head>
  <body role="document">
  <div id="header">
    <h1 id="logo"><a href="http://www.openstack.org/">OpenStack</a></h1>
    <ul id="navigation">
      
      <li><a href="http://www.openstack.org/" title="Go to the Home page" class="link">Home</a></li>
      <li><a href="http://www.openstack.org/projects/" title="Go to the OpenStack Projects page">Projects</a></li>
      <li><a href="http://www.openstack.org/user-stories/" title="Go to the User Stories page" class="link">User Stories</a></li>
      <li><a href="http://www.openstack.org/community/" title="Go to the Community page" class="link">Community</a></li>
      <li><a href="http://www.openstack.org/blog/" title="Go to the OpenStack Blog">Blog</a></li>
      <li><a href="http://wiki.openstack.org/" title="Go to the OpenStack Wiki">Wiki</a></li>
      <li><a href="http://docs.openstack.org/" title="Go to OpenStack Documentation" class="current">Documentation</a></li>
      
    </ul>
  </div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="hello-world">
<h1>Hello world<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#hello-world" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/hello_world.py">hello_world</a>.</p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">unordered_flow</span> <span class="k">as</span> <span class="n">uf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>


<span class="c1"># INTRO: This is the defacto hello world equivalent for taskflow; it shows how</span>
<span class="c1"># an overly simplistic workflow can be created that runs using different</span>
<span class="c1"># engines using different styles of execution (all can be used to run in</span>
<span class="c1"># parallel if a workflow is provided that is parallelizable).</span>

<span class="k">class</span> <span class="nc">PrinterTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">show_name</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">inject</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PrinterTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">inject</span><span class="o">=</span><span class="n">inject</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_show_name</span> <span class="o">=</span> <span class="n">show_name</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_show_name</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">output</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>


<span class="c1"># This will be the work that we want done, which for this example is just to</span>
<span class="c1"># print 'hello world' (like a song) using different tasks and different</span>
<span class="c1"># execution models.</span>
<span class="n">song</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"beats"</span><span class="p">)</span>

<span class="c1"># Unordered flows when ran can be ran in parallel; and a chorus is everyone</span>
<span class="c1"># singing at once of course!</span>
<span class="n">hi_chorus</span> <span class="o">=</span> <span class="n">uf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'hello'</span><span class="p">)</span>
<span class="n">world_chorus</span> <span class="o">=</span> <span class="n">uf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'world'</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">hello</span><span class="p">,</span> <span class="n">world</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[(</span><span class="s1">'bob'</span><span class="p">,</span> <span class="s1">'hello'</span><span class="p">,</span> <span class="s1">'world'</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">'joe'</span><span class="p">,</span> <span class="s1">'hellooo'</span><span class="p">,</span> <span class="s1">'worllllld'</span><span class="p">),</span>
                             <span class="p">(</span><span class="s1">'sue'</span><span class="p">,</span> <span class="s2">"helloooooo!"</span><span class="p">,</span> <span class="s1">'wooorllld!'</span><span class="p">)]:</span>
    <span class="n">hi_chorus</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">PrinterTask</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">@hello"</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                              <span class="c1"># This will show up to the execute() method of</span>
                              <span class="c1"># the task as the argument named 'output' (which</span>
                              <span class="c1"># will allow us to print the character we want).</span>
                              <span class="n">inject</span><span class="o">=</span><span class="p">{</span><span class="s1">'output'</span><span class="p">:</span> <span class="n">hello</span><span class="p">}))</span>
    <span class="n">world_chorus</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">PrinterTask</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">@world"</span> <span class="o">%</span> <span class="n">name</span><span class="p">,</span>
                                 <span class="n">inject</span><span class="o">=</span><span class="p">{</span><span class="s1">'output'</span><span class="p">:</span> <span class="n">world</span><span class="p">}))</span>

<span class="c1"># The composition starts with the conductor and then runs in sequence with</span>
<span class="c1"># the chorus running in parallel, but no matter what the 'hello' chorus must</span>
<span class="c1"># always run before the 'world' chorus (otherwise the world will fall apart).</span>
<span class="n">song</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">PrinterTask</span><span class="p">(</span><span class="s2">"conductor@begin"</span><span class="p">,</span>
                     <span class="n">show_name</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">inject</span><span class="o">=</span><span class="p">{</span><span class="s1">'output'</span><span class="p">:</span> <span class="s2">"*ding*"</span><span class="p">}),</span>
         <span class="n">hi_chorus</span><span class="p">,</span>
         <span class="n">world_chorus</span><span class="p">,</span>
         <span class="n">PrinterTask</span><span class="p">(</span><span class="s2">"conductor@end"</span><span class="p">,</span>
                     <span class="n">show_name</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">inject</span><span class="o">=</span><span class="p">{</span><span class="s1">'output'</span><span class="p">:</span> <span class="s2">"*dong*"</span><span class="p">}))</span>

<span class="c1"># Run in parallel using eventlet green threads...</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">eventlet</span> <span class="kn">as</span> <span class="nn">_eventlet</span>  <span class="c1"># noqa</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># No eventlet currently active, skip running with it...</span>
    <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"-- Running in parallel using eventlet --"</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">song</span><span class="p">,</span> <span class="n">executor</span><span class="o">=</span><span class="s1">'greenthreaded'</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'parallel'</span><span class="p">,</span>
                     <span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">e</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


<span class="c1"># Run in parallel using real threads...</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"-- Running in parallel using threads --"</span><span class="p">)</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">song</span><span class="p">,</span> <span class="n">executor</span><span class="o">=</span><span class="s1">'threaded'</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'parallel'</span><span class="p">,</span>
                 <span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">e</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


<span class="c1"># Run in parallel using external processes...</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"-- Running in parallel using processes --"</span><span class="p">)</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">song</span><span class="p">,</span> <span class="n">executor</span><span class="o">=</span><span class="s1">'processes'</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'parallel'</span><span class="p">,</span>
                 <span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">e</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


<span class="c1"># Run serially (aka, if the workflow could have been ran in parallel, it will</span>
<span class="c1"># not be when ran in this mode)...</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"-- Running serially --"</span><span class="p">)</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">song</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'serial'</span><span class="p">)</span>
<span class="n">e</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"-- Statistics gathered --"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">statistics</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="passing-values-from-and-to-tasks">
<h1>Passing values from and to tasks<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#passing-values-from-and-to-tasks" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/simple_linear_pass.py">simple_linear_pass</a>.</p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">self_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">self_dir</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>

<span class="c1"># INTRO: This example shows how a task (in a linear/serial workflow) can</span>
<span class="c1"># produce an output that can be then consumed/used by a downstream task.</span>


<span class="k">class</span> <span class="nc">TaskA</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="n">default_provides</span> <span class="o">=</span> <span class="s1">'a'</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Executing '</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">'a'</span>


<span class="k">class</span> <span class="nc">TaskB</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Executing '</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Got input '</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">))</span>


<span class="k">print</span><span class="p">(</span><span class="s2">"Constructing..."</span><span class="p">)</span>
<span class="n">wf</span> <span class="o">=</span> <span class="n">linear_flow</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"pass-from-to"</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">TaskA</span><span class="p">(</span><span class="s1">'a'</span><span class="p">),</span> <span class="n">TaskB</span><span class="p">(</span><span class="s1">'b'</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"Loading..."</span><span class="p">)</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"Compiling..."</span><span class="p">)</span>
<span class="n">e</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"Preparing..."</span><span class="p">)</span>
<span class="n">e</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"Running..."</span><span class="p">)</span>
<span class="n">e</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"Done..."</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="using-listeners">
<h1>Using listeners<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#using-listeners" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/echo_listener.py">echo_listener</a>.</p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.listeners</span> <span class="kn">import</span> <span class="n">logging</span> <span class="k">as</span> <span class="n">logging_listener</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>

<span class="c1"># INTRO: This example walks through a miniature workflow which will do a</span>
<span class="c1"># simple echo operation; during this execution a listener is associated with</span>
<span class="c1"># the engine to receive all notifications about what the flow has performed,</span>
<span class="c1"># this example dumps that output to the stdout for viewing (at debug level</span>
<span class="c1"># to show all the information which is possible).</span>


<span class="k">class</span> <span class="nc">Echo</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<span class="c1"># Generate the work to be done (but don't do it yet).</span>
<span class="n">wf</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'abc'</span><span class="p">)</span>
<span class="n">wf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Echo</span><span class="p">(</span><span class="s1">'a'</span><span class="p">))</span>
<span class="n">wf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Echo</span><span class="p">(</span><span class="s1">'b'</span><span class="p">))</span>
<span class="n">wf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Echo</span><span class="p">(</span><span class="s1">'c'</span><span class="p">))</span>

<span class="c1"># This will associate the listener with the engine (the listener</span>
<span class="c1"># will automatically register for notifications with the engine and deregister</span>
<span class="c1"># when the context is exited).</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span>
<span class="k">with</span> <span class="n">logging_listener</span><span class="o">.</span><span class="n">DynamicLoggingListener</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="n">e</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="using-listeners-to-watch-a-phone-call">
<h1>Using listeners (to watch a phone call)<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#using-listeners-to-watch-a-phone-call" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/simple_linear_listening.py">simple_linear_listening</a>.</p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">taskflow.engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>
<span class="kn">from</span> <span class="nn">taskflow.types</span> <span class="kn">import</span> <span class="n">notifier</span>

<span class="n">ANY</span> <span class="o">=</span> <span class="n">notifier</span><span class="o">.</span><span class="n">Notifier</span><span class="o">.</span><span class="n">ANY</span>

<span class="c1"># INTRO: In this example we create two tasks (this time as functions instead</span>
<span class="c1"># of task subclasses as in the simple_linear.py example), each of which ~calls~</span>
<span class="c1"># a given ~phone~ number (provided as a function input) in a linear fashion</span>
<span class="c1"># (one after the other).</span>
<span class="c1">#</span>
<span class="c1"># For a workflow which is serial this shows an extremely simple way</span>
<span class="c1"># of structuring your tasks (the code that does the work) into a linear</span>
<span class="c1"># sequence (the flow) and then passing the work off to an engine, with some</span>
<span class="c1"># initial data to be ran in a reliable manner.</span>
<span class="c1">#</span>
<span class="c1"># This example shows a basic usage of the taskflow structures without involving</span>
<span class="c1"># the complexity of persistence. Using the structures that taskflow provides</span>
<span class="c1"># via tasks and flows makes it possible for you to easily at a later time</span>
<span class="c1"># hook in a persistence layer (and then gain the functionality that offers)</span>
<span class="c1"># when you decide the complexity of adding that layer in is 'worth it' for your</span>
<span class="c1"># applications usage pattern (which some applications may not need).</span>
<span class="c1">#</span>
<span class="c1"># It **also** adds on to the simple_linear.py example by adding a set of</span>
<span class="c1"># callback functions which the engine will call when a flow state transition</span>
<span class="c1"># or task state transition occurs. These types of functions are useful for</span>
<span class="c1"># updating task or flow progress, or for debugging, sending notifications to</span>
<span class="c1"># external systems, or for other yet unknown future usage that you may create!</span>


<span class="k">def</span> <span class="nf">call_jim</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Calling jim."</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Context = </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>


<span class="k">def</span> <span class="nf">call_joe</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Calling joe."</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Context = </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>


<span class="k">def</span> <span class="nf">flow_watch</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'Flow =&gt; </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="n">state</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">task_watch</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'Task </span><span class="si">%s</span><span class="s1"> =&gt; </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'task_name'</span><span class="p">),</span> <span class="n">state</span><span class="p">))</span>


<span class="c1"># Wrap your functions into a task type that knows how to treat your functions</span>
<span class="c1"># as tasks. There was previous work done to just allow a function to be</span>
<span class="c1"># directly passed, but in python 3.0 there is no easy way to capture an</span>
<span class="c1"># instance method, so this wrapping approach was decided upon instead which</span>
<span class="c1"># can attach to instance methods (if that's desired).</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"Call-them"</span><span class="p">)</span>
<span class="n">flow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">FunctorTask</span><span class="p">(</span><span class="n">execute</span><span class="o">=</span><span class="n">call_jim</span><span class="p">))</span>
<span class="n">flow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">FunctorTask</span><span class="p">(</span><span class="n">execute</span><span class="o">=</span><span class="n">call_joe</span><span class="p">))</span>

<span class="c1"># Now load (but do not run) the flow using the provided initial data.</span>
<span class="n">engine</span> <span class="o">=</span> <span class="n">taskflow</span><span class="o">.</span><span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="p">{</span>
    <span class="s1">'context'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"joe_number"</span><span class="p">:</span> <span class="mi">444</span><span class="p">,</span>
        <span class="s2">"jim_number"</span><span class="p">:</span> <span class="mi">555</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">})</span>

<span class="c1"># This is where we attach our callback functions to the 2 different</span>
<span class="c1"># notification objects that an engine exposes. The usage of a ANY (kleene star)</span>
<span class="c1"># here means that we want to be notified on all state changes, if you want to</span>
<span class="c1"># restrict to a specific state change, just register that instead.</span>
<span class="n">engine</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ANY</span><span class="p">,</span> <span class="n">flow_watch</span><span class="p">)</span>
<span class="n">engine</span><span class="o">.</span><span class="n">atom_notifier</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ANY</span><span class="p">,</span> <span class="n">task_watch</span><span class="p">)</span>

<span class="c1"># And now run!</span>
<span class="n">engine</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="dumping-a-in-memory-backend">
<h1>Dumping a in-memory backend<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#dumping-a-in-memory-backend" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/dump_memory_backend.py">dump_memory_backend</a>.</p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">self_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">self_dir</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>

<span class="c1"># INTRO: in this example we create a dummy flow with a dummy task, and run</span>
<span class="c1"># it using a in-memory backend and pre/post run we dump out the contents</span>
<span class="c1"># of the in-memory backends tree structure (which can be quite useful to</span>
<span class="c1"># look at for debugging or other analysis).</span>


<span class="k">class</span> <span class="nc">PrintTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Running '</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="c1"># Make a little flow and run it...</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'root'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">'a'</span><span class="p">,</span> <span class="s1">'b'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">]:</span>
    <span class="n">f</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">PrintTask</span><span class="p">(</span><span class="n">alpha</span><span class="p">))</span>

<span class="n">e</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">e</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
<span class="n">e</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>

<span class="c1"># After prepare the storage layer + backend can now be accessed safely...</span>
<span class="n">backend</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">backend</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"----------"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"Before run"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"----------"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">pformat</span><span class="p">())</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"----------"</span><span class="p">)</span>

<span class="n">e</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"---------"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"After run"</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"---------"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">backend</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">ls_r</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">memory</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="n">absolute</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">memory</span><span class="p">[</span><span class="n">path</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> -&gt; </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="making-phone-calls">
<h1>Making phone calls<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#making-phone-calls" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/simple_linear.py">simple_linear</a>.</p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">taskflow.engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>

<span class="c1"># INTRO: In this example we create two tasks, each of which ~calls~ a given</span>
<span class="c1"># ~phone~ number (provided as a function input) in a linear fashion (one after</span>
<span class="c1"># the other). For a workflow which is serial this shows a extremely simple way</span>
<span class="c1"># of structuring your tasks (the code that does the work) into a linear</span>
<span class="c1"># sequence (the flow) and then passing the work off to an engine, with some</span>
<span class="c1"># initial data to be ran in a reliable manner.</span>
<span class="c1">#</span>
<span class="c1"># NOTE(harlowja): This example shows a basic usage of the taskflow structures</span>
<span class="c1"># without involving the complexity of persistence. Using the structures that</span>
<span class="c1"># taskflow provides via tasks and flows makes it possible for you to easily at</span>
<span class="c1"># a later time hook in a persistence layer (and then gain the functionality</span>
<span class="c1"># that offers) when you decide the complexity of adding that layer in</span>
<span class="c1"># is 'worth it' for your application's usage pattern (which certain</span>
<span class="c1"># applications may not need).</span>


<span class="k">class</span> <span class="nc">CallJim</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jim_number</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Calling jim </span><span class="si">%s</span><span class="s2">."</span> <span class="o">%</span> <span class="n">jim_number</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CallJoe</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joe_number</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Calling joe </span><span class="si">%s</span><span class="s2">."</span> <span class="o">%</span> <span class="n">joe_number</span><span class="p">)</span>


<span class="c1"># Create your flow and associated tasks (the work to be done).</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'simple-linear'</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="n">CallJim</span><span class="p">(),</span>
    <span class="n">CallJoe</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># Now run that flow using the provided initial data (store below).</span>
<span class="n">taskflow</span><span class="o">.</span><span class="n">engines</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">joe_number</span><span class="o">=</span><span class="mi">444</span><span class="p">,</span>
                                      <span class="n">jim_number</span><span class="o">=</span><span class="mi">555</span><span class="p">))</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="making-phone-calls-automatically-reverting">
<h1>Making phone calls (automatically reverting)<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#making-phone-calls-automatically-reverting" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/reverting_linear.py">reverting_linear</a>.</p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">taskflow.engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>

<span class="c1"># INTRO: In this example we create three tasks, each of which ~calls~ a given</span>
<span class="c1"># number (provided as a function input), one of those tasks *fails* calling a</span>
<span class="c1"># given number (the suzzie calling); this causes the workflow to enter the</span>
<span class="c1"># reverting process, which activates the revert methods of the previous two</span>
<span class="c1"># phone ~calls~.</span>
<span class="c1">#</span>
<span class="c1"># This simulated calling makes it appear like all three calls occur or all</span>
<span class="c1"># three don't occur (transaction-like capabilities). No persistence layer is</span>
<span class="c1"># used here so reverting and executing will *not* be tolerant of process</span>
<span class="c1"># failure.</span>


<span class="k">class</span> <span class="nc">CallJim</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jim_number</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Calling jim </span><span class="si">%s</span><span class="s2">."</span> <span class="o">%</span> <span class="n">jim_number</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">revert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jim_number</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Calling </span><span class="si">%s</span><span class="s2"> and apologizing."</span> <span class="o">%</span> <span class="n">jim_number</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CallJoe</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joe_number</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Calling joe </span><span class="si">%s</span><span class="s2">."</span> <span class="o">%</span> <span class="n">joe_number</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">revert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">joe_number</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Calling </span><span class="si">%s</span><span class="s2"> and apologizing."</span> <span class="o">%</span> <span class="n">joe_number</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CallSuzzie</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suzzie_number</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s2">"Suzzie not home right now."</span><span class="p">)</span>


<span class="c1"># Create your flow and associated tasks (the work to be done).</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'simple-linear'</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="n">CallJim</span><span class="p">(),</span>
    <span class="n">CallJoe</span><span class="p">(),</span>
    <span class="n">CallSuzzie</span><span class="p">()</span>
<span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Now run that flow using the provided initial data (store below).</span>
    <span class="n">taskflow</span><span class="o">.</span><span class="n">engines</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">joe_number</span><span class="o">=</span><span class="mi">444</span><span class="p">,</span>
                                          <span class="n">jim_number</span><span class="o">=</span><span class="mi">555</span><span class="p">,</span>
                                          <span class="n">suzzie_number</span><span class="o">=</span><span class="mi">666</span><span class="p">))</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># NOTE(harlowja): This exception will be the exception that came out of the</span>
    <span class="c1"># 'CallSuzzie' task instead of a different exception, this is useful since</span>
    <span class="c1"># typically surrounding code wants to handle the original exception and not</span>
    <span class="c1"># a wrapped or altered one.</span>
    <span class="c1">#</span>
    <span class="c1"># *WARNING* If this flow was multi-threaded and multiple active tasks threw</span>
    <span class="c1"># exceptions then the above exception would be wrapped into a combined</span>
    <span class="c1"># exception (the object has methods to iterate over the contained</span>
    <span class="c1"># exceptions). See: exceptions.py and the class 'WrappedFailure' to look at</span>
    <span class="c1"># how to deal with multiple tasks failing while running.</span>
    <span class="c1">#</span>
    <span class="c1"># You will also note that this is not a problem in this case since no</span>
    <span class="c1"># parallelism is involved; this is ensured by the usage of a linear flow</span>
    <span class="c1"># and the default engine type which is 'serial' vs being 'parallel'.</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Flow failed: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="building-a-car">
<h1>Building a car<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#building-a-car" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/build_a_car.py">build_a_car</a>.</p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>


<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>


<span class="kn">import</span> <span class="nn">taskflow.engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">graph_flow</span> <span class="k">as</span> <span class="n">gf</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>
<span class="kn">from</span> <span class="nn">taskflow.types</span> <span class="kn">import</span> <span class="n">notifier</span>

<span class="n">ANY</span> <span class="o">=</span> <span class="n">notifier</span><span class="o">.</span><span class="n">Notifier</span><span class="o">.</span><span class="n">ANY</span>

<span class="kn">import</span> <span class="nn">example_utils</span> <span class="kn">as</span> <span class="nn">eu</span>  <span class="c1"># noqa</span>


<span class="c1"># INTRO: This example shows how a graph flow and linear flow can be used</span>
<span class="c1"># together to execute dependent &amp; non-dependent tasks by going through the</span>
<span class="c1"># steps required to build a simplistic car (an assembly line if you will). It</span>
<span class="c1"># also shows how raw functions can be wrapped into a task object instead of</span>
<span class="c1"># being forced to use the more *heavy* task base class. This is useful in</span>
<span class="c1"># scenarios where pre-existing code has functions that you easily want to</span>
<span class="c1"># plug-in to taskflow, without requiring a large amount of code changes.</span>


<span class="k">def</span> <span class="nf">build_frame</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">'steel'</span>


<span class="k">def</span> <span class="nf">build_engine</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">'honda'</span>


<span class="k">def</span> <span class="nf">build_doors</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">'2'</span>


<span class="k">def</span> <span class="nf">build_wheels</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">'4'</span>


<span class="c1"># These just return true to indiciate success, they would in the real work</span>
<span class="c1"># do more than just that.</span>

<span class="k">def</span> <span class="nf">install_engine</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">engine</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">True</span>


<span class="k">def</span> <span class="nf">install_doors</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">windows_installed</span><span class="p">,</span> <span class="n">doors</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">True</span>


<span class="k">def</span> <span class="nf">install_windows</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">doors</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">True</span>


<span class="k">def</span> <span class="nf">install_wheels</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">engine</span><span class="p">,</span> <span class="n">engine_installed</span><span class="p">,</span> <span class="n">wheels</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">True</span>


<span class="k">def</span> <span class="nf">trash</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">eu</span><span class="o">.</span><span class="n">print_wrapped</span><span class="p">(</span><span class="s2">"Throwing away pieces of car!"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">startup</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># If you want to see the rollback function being activated try uncommenting</span>
    <span class="c1"># the following line.</span>
    <span class="c1">#</span>
    <span class="c1"># raise ValueError("Car not verified")</span>
    <span class="k">return</span> <span class="bp">True</span>


<span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># If the car is not what we ordered throw away the car (trigger reversion).</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">spec</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Car doesn't match spec!"</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">True</span>


<span class="c1"># These two functions connect into the state transition notification emission</span>
<span class="c1"># points that the engine outputs, they can be used to log state transitions</span>
<span class="c1"># that are occurring, or they can be used to suspend the engine (or perform</span>
<span class="c1"># other useful activities).</span>
<span class="k">def</span> <span class="nf">flow_watch</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'Flow =&gt; </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="n">state</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">task_watch</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">'Task </span><span class="si">%s</span><span class="s1"> =&gt; </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'task_name'</span><span class="p">),</span> <span class="n">state</span><span class="p">))</span>


<span class="n">flow</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"make-auto"</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="n">task</span><span class="o">.</span><span class="n">FunctorTask</span><span class="p">(</span><span class="n">startup</span><span class="p">,</span> <span class="n">revert</span><span class="o">=</span><span class="n">trash</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'ran'</span><span class="p">),</span>
    <span class="c1"># A graph flow allows automatic dependency based ordering, the ordering</span>
    <span class="c1"># is determined by analyzing the symbols required and provided and ordering</span>
    <span class="c1"># execution based on a functioning order (if one exists).</span>
    <span class="n">gf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"install-parts"</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">task</span><span class="o">.</span><span class="n">FunctorTask</span><span class="p">(</span><span class="n">build_frame</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'frame'</span><span class="p">),</span>
        <span class="n">task</span><span class="o">.</span><span class="n">FunctorTask</span><span class="p">(</span><span class="n">build_engine</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'engine'</span><span class="p">),</span>
        <span class="n">task</span><span class="o">.</span><span class="n">FunctorTask</span><span class="p">(</span><span class="n">build_doors</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'doors'</span><span class="p">),</span>
        <span class="n">task</span><span class="o">.</span><span class="n">FunctorTask</span><span class="p">(</span><span class="n">build_wheels</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'wheels'</span><span class="p">),</span>
        <span class="c1"># These *_installed outputs allow for other tasks to depend on certain</span>
        <span class="c1"># actions being performed (aka the components were installed), another</span>
        <span class="c1"># way to do this is to link() the tasks manually instead of creating</span>
        <span class="c1"># an 'artificial' data dependency that accomplishes the same goal the</span>
        <span class="c1"># manual linking would result in.</span>
        <span class="n">task</span><span class="o">.</span><span class="n">FunctorTask</span><span class="p">(</span><span class="n">install_engine</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'engine_installed'</span><span class="p">),</span>
        <span class="n">task</span><span class="o">.</span><span class="n">FunctorTask</span><span class="p">(</span><span class="n">install_doors</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'doors_installed'</span><span class="p">),</span>
        <span class="n">task</span><span class="o">.</span><span class="n">FunctorTask</span><span class="p">(</span><span class="n">install_windows</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'windows_installed'</span><span class="p">),</span>
        <span class="n">task</span><span class="o">.</span><span class="n">FunctorTask</span><span class="p">(</span><span class="n">install_wheels</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'wheels_installed'</span><span class="p">)),</span>
    <span class="n">task</span><span class="o">.</span><span class="n">FunctorTask</span><span class="p">(</span><span class="n">verify</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="p">[</span><span class="s1">'frame'</span><span class="p">,</span>
                                       <span class="s1">'engine'</span><span class="p">,</span>
                                       <span class="s1">'doors'</span><span class="p">,</span>
                                       <span class="s1">'wheels'</span><span class="p">,</span>
                                       <span class="s1">'engine_installed'</span><span class="p">,</span>
                                       <span class="s1">'doors_installed'</span><span class="p">,</span>
                                       <span class="s1">'windows_installed'</span><span class="p">,</span>
                                       <span class="s1">'wheels_installed'</span><span class="p">]))</span>

<span class="c1"># This dictionary will be provided to the tasks as a specification for what</span>
<span class="c1"># the tasks should produce, in this example this specification will influence</span>
<span class="c1"># what those tasks do and what output they create. Different tasks depend on</span>
<span class="c1"># different information from this specification, all of which will be provided</span>
<span class="c1"># automatically by the engine to those tasks.</span>
<span class="n">spec</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"frame"</span><span class="p">:</span> <span class="s1">'steel'</span><span class="p">,</span>
    <span class="s2">"engine"</span><span class="p">:</span> <span class="s1">'honda'</span><span class="p">,</span>
    <span class="s2">"doors"</span><span class="p">:</span> <span class="s1">'2'</span><span class="p">,</span>
    <span class="s2">"wheels"</span><span class="p">:</span> <span class="s1">'4'</span><span class="p">,</span>
    <span class="c1"># These are used to compare the result product, a car without the pieces</span>
    <span class="c1"># installed is not a car after all.</span>
    <span class="s2">"engine_installed"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="s2">"doors_installed"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="s2">"windows_installed"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
    <span class="s2">"wheels_installed"</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
<span class="p">}</span>


<span class="n">engine</span> <span class="o">=</span> <span class="n">taskflow</span><span class="o">.</span><span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="p">{</span><span class="s1">'spec'</span><span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">copy</span><span class="p">()})</span>

<span class="c1"># This registers all (ANY) state transitions to trigger a call to the</span>
<span class="c1"># flow_watch function for flow state transitions, and registers the</span>
<span class="c1"># same all (ANY) state transitions for task state transitions.</span>
<span class="n">engine</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ANY</span><span class="p">,</span> <span class="n">flow_watch</span><span class="p">)</span>
<span class="n">engine</span><span class="o">.</span><span class="n">atom_notifier</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ANY</span><span class="p">,</span> <span class="n">task_watch</span><span class="p">)</span>

<span class="n">eu</span><span class="o">.</span><span class="n">print_wrapped</span><span class="p">(</span><span class="s2">"Building a car"</span><span class="p">)</span>
<span class="n">engine</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># Alter the specification and ensure that the reverting logic gets triggered</span>
<span class="c1"># since the resultant car that will be built by the build_wheels function will</span>
<span class="c1"># build a car with 4 doors only (not 5), this will cause the verification</span>
<span class="c1"># task to mark the car that is produced as not matching the desired spec.</span>
<span class="n">spec</span><span class="p">[</span><span class="s1">'doors'</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">taskflow</span><span class="o">.</span><span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="p">{</span><span class="s1">'spec'</span><span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">copy</span><span class="p">()})</span>
<span class="n">engine</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ANY</span><span class="p">,</span> <span class="n">flow_watch</span><span class="p">)</span>
<span class="n">engine</span><span class="o">.</span><span class="n">atom_notifier</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ANY</span><span class="p">,</span> <span class="n">task_watch</span><span class="p">)</span>

<span class="n">eu</span><span class="o">.</span><span class="n">print_wrapped</span><span class="p">(</span><span class="s2">"Building a wrong car that doesn't match specification"</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">eu</span><span class="o">.</span><span class="n">print_wrapped</span><span class="p">(</span><span class="s2">"Flow failed: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="iterating-over-the-alphabet-using-processes">
<h1>Iterating over the alphabet (using processes)<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#iterating-over-the-alphabet-using-processes" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/alphabet_soup.py">alphabet_soup</a>.</p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">fractions</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">self_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">self_dir</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>


<span class="c1"># In this example we show how a simple linear set of tasks can be executed</span>
<span class="c1"># using local processes (and not threads or remote workers) with minimal (if</span>
<span class="c1"># any) modification to those tasks to make them safe to run in this mode.</span>
<span class="c1">#</span>
<span class="c1"># This is useful since it allows further scaling up your workflows when thread</span>
<span class="c1"># execution starts to become a bottleneck (which it can start to be due to the</span>
<span class="c1"># GIL in python). It also offers a intermediary scalable runner that can be</span>
<span class="c1"># used when the scale and/or setup of remote workers is not desirable.</span>


<span class="k">def</span> <span class="nf">progress_printer</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">event_type</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
    <span class="c1"># This callback, attached to each task will be called in the local</span>
    <span class="c1"># process (not the child processes)...</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="n">details</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">'progress'</span><span class="p">)</span>
    <span class="n">progress</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">progress</span> <span class="o">*</span> <span class="mf">100.0</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Task '</span><span class="si">%s</span><span class="s2">' reached </span><span class="si">%d%%</span><span class="s2"> completion"</span> <span class="o">%</span> <span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">progress</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">AlphabetTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="c1"># Second delay between each progress part.</span>
    <span class="n">_DELAY</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="c1"># This task will run in X main stages (each with a different progress</span>
    <span class="c1"># report that will be delivered back to the running process...). The</span>
    <span class="c1"># initial 0% and 100% are triggered automatically by the engine when</span>
    <span class="c1"># a task is started and finished (so that's why those are not emitted</span>
    <span class="c1"># here).</span>
    <span class="n">_PROGRESS_PARTS</span> <span class="o">=</span> <span class="p">[</span><span class="n">fractions</span><span class="o">.</span><span class="n">Fraction</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">/5"</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_PROGRESS_PARTS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_progress</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_DELAY</span><span class="p">)</span>


<span class="k">print</span><span class="p">(</span><span class="s2">"Constructing..."</span><span class="p">)</span>
<span class="n">soup</span> <span class="o">=</span> <span class="n">linear_flow</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"alphabet-soup"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span><span class="p">:</span>
    <span class="n">abc</span> <span class="o">=</span> <span class="n">AlphabetTask</span><span class="p">(</span><span class="n">letter</span><span class="p">)</span>
    <span class="n">abc</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">EVENT_UPDATE_PROGRESS</span><span class="p">,</span>
                          <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">progress_printer</span><span class="p">,</span> <span class="n">abc</span><span class="p">))</span>
    <span class="n">soup</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">abc</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Loading..."</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'parallel'</span><span class="p">,</span> <span class="n">executor</span><span class="o">=</span><span class="s1">'processes'</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Compiling..."</span><span class="p">)</span>
    <span class="n">e</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Preparing..."</span><span class="p">)</span>
    <span class="n">e</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Running..."</span><span class="p">)</span>
    <span class="n">e</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Done: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">statistics</span><span class="p">)</span>
<span class="k">except</span> <span class="n">exceptions</span><span class="o">.</span><span class="n">NotImplementedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="watching-execution-timing">
<h1>Watching execution timing<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#watching-execution-timing" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/timing_listener.py">timing_listener</a>.</p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.listeners</span> <span class="kn">import</span> <span class="n">timing</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>

<span class="c1"># INTRO: in this example we will attach a listener to an engine</span>
<span class="c1"># and have variable run time tasks run and show how the listener will print</span>
<span class="c1"># out how long those tasks took (when they started and when they finished).</span>
<span class="c1">#</span>
<span class="c1"># This shows how timing metrics can be gathered (or attached onto an engine)</span>
<span class="c1"># after a workflow has been constructed, making it easy to gather metrics</span>
<span class="c1"># dynamically for situations where this kind of information is applicable (or</span>
<span class="c1"># even adding this information on at a later point in the future when your</span>
<span class="c1"># application starts to slow down).</span>


<span class="k">class</span> <span class="nc">VariableTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">VariableTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sleepy_time</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sleepy_time</span><span class="p">)</span>


<span class="n">f</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'root'</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">VariableTask</span><span class="p">(</span><span class="s1">'a'</span><span class="p">),</span> <span class="n">VariableTask</span><span class="p">(</span><span class="s1">'b'</span><span class="p">),</span> <span class="n">VariableTask</span><span class="p">(</span><span class="s1">'c'</span><span class="p">))</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="k">with</span> <span class="n">timing</span><span class="o">.</span><span class="n">PrintingDurationListener</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="n">e</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="distance-calculator">
<h1>Distance calculator<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#distance-calculator" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/distance_calculator.py">distance_calculator</a></p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>

<span class="c1"># INTRO: This shows how to use a tasks/atoms ability to take requirements from</span>
<span class="c1"># its execute functions default parameters and shows how to provide those</span>
<span class="c1"># via different methods when needed, to influence those parameters to in</span>
<span class="c1"># this case calculate the distance between two points in 2D space.</span>

<span class="c1"># A 2D point.</span>
<span class="n">Point</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">"Point"</span><span class="p">,</span> <span class="s2">"x,y"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">is_near</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
    <span class="c1"># Floats don't really provide equality...</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">expected</span> <span class="o">+</span> <span class="n">tolerance</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">expected</span> <span class="o">-</span> <span class="n">tolerance</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>


<span class="k">class</span> <span class="nc">DistanceTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="c1"># See: http://en.wikipedia.org/wiki/Distance#Distance_in_Euclidean_space</span>

    <span class="n">default_provides</span> <span class="o">=</span> <span class="s1">'distance'</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">b</span><span class="o">=</span><span class="n">Point</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">a</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="c1"># For these we rely on the execute() methods points by default being</span>
    <span class="c1"># at the origin (and we override it with store values when we want) at</span>
    <span class="c1"># execution time (which then influences what is calculated).</span>
    <span class="n">any_distance</span> <span class="o">=</span> <span class="n">linear_flow</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"origin"</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">DistanceTask</span><span class="p">())</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">any_distance</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> is near-enough to </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">'distance'</span><span class="p">],</span>
                                           <span class="mf">0.0</span><span class="p">,</span>
                                           <span class="n">is_near</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">'distance'</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)))</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">any_distance</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="p">{</span><span class="s1">'a'</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)})</span>
    <span class="k">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> is near-enough to </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">'distance'</span><span class="p">],</span>
                                           <span class="mf">1.4142</span><span class="p">,</span>
                                           <span class="n">is_near</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">'distance'</span><span class="p">],</span>
                                                   <span class="mf">1.4142</span><span class="p">)))</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">any_distance</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="p">{</span><span class="s1">'a'</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)})</span>
    <span class="k">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> is near-enough to </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">'distance'</span><span class="p">],</span>
                                           <span class="mf">14.14199</span><span class="p">,</span>
                                           <span class="n">is_near</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">'distance'</span><span class="p">],</span>
                                                   <span class="mf">14.14199</span><span class="p">)))</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">any_distance</span><span class="p">,</span>
                          <span class="n">store</span><span class="o">=</span><span class="p">{</span><span class="s1">'a'</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="s1">'b'</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)})</span>
    <span class="k">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> is near-enough to </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">'distance'</span><span class="p">],</span>
                                           <span class="mf">7.07106</span><span class="p">,</span>
                                           <span class="n">is_near</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">'distance'</span><span class="p">],</span>
                                                   <span class="mf">7.07106</span><span class="p">)))</span>

    <span class="c1"># For this we use the ability to override at task creation time the</span>
    <span class="c1"># optional arguments so that we don't need to continue to send them</span>
    <span class="c1"># in via the 'store' argument like in the above (and we fix the new</span>
    <span class="c1"># starting point 'a' at (10, 10) instead of (0, 0)...</span>

    <span class="n">ten_distance</span> <span class="o">=</span> <span class="n">linear_flow</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"ten"</span><span class="p">)</span>
    <span class="n">ten_distance</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">DistanceTask</span><span class="p">(</span><span class="n">inject</span><span class="o">=</span><span class="p">{</span><span class="s1">'a'</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)}))</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">ten_distance</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="p">{</span><span class="s1">'b'</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)})</span>
    <span class="k">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> is near-enough to </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">'distance'</span><span class="p">],</span>
                                           <span class="mf">0.0</span><span class="p">,</span>
                                           <span class="n">is_near</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">'distance'</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)))</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">ten_distance</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> is near-enough to </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">'distance'</span><span class="p">],</span>
                                           <span class="mf">14.14199</span><span class="p">,</span>
                                           <span class="n">is_near</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">'distance'</span><span class="p">],</span>
                                                   <span class="mf">14.14199</span><span class="p">)))</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="table-multiplier-in-parallel">
<h1>Table multiplier (in parallel)<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#table-multiplier-in-parallel" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/parallel_table_multiply.py">parallel_table_multiply</a></p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">futurist</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">range</span> <span class="k">as</span> <span class="n">compat_range</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">unordered_flow</span> <span class="k">as</span> <span class="n">uf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>

<span class="c1"># INTRO: This example walks through a miniature workflow which does a parallel</span>
<span class="c1"># table modification where each row in the table gets adjusted by a thread, or</span>
<span class="c1"># green thread (if eventlet is available) in parallel and then the result</span>
<span class="c1"># is reformed into a new table and some verifications are performed on it</span>
<span class="c1"># to ensure everything went as expected.</span>


<span class="n">MULTIPLER</span> <span class="o">=</span> <span class="mi">10</span>


<span class="k">class</span> <span class="nc">RowMultiplier</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">"""Performs a modification of an input row, creating a output row."""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RowMultiplier</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="n">row</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">r</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiplier</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">row</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">make_flow</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
    <span class="c1"># This creation will allow for parallel computation (since the flow here</span>
    <span class="c1"># is specifically unordered; and when things are unordered they have</span>
    <span class="c1"># no dependencies and when things have no dependencies they can just be</span>
    <span class="c1"># ran at the same time, limited in concurrency by the executor or max</span>
    <span class="c1"># workers of that executor...)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">uf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"root"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
        <span class="n">f</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">RowMultiplier</span><span class="p">(</span><span class="s2">"m-</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">MULTIPLER</span><span class="p">))</span>
    <span class="c1"># NOTE(harlowja): at this point nothing has ran, the above is just</span>
    <span class="c1"># defining what should be done (but not actually doing it) and associating</span>
    <span class="c1"># an ordering dependencies that should be enforced (the flow pattern used</span>
    <span class="c1"># forces this), the engine in the later main() function will actually</span>
    <span class="c1"># perform this work...</span>
    <span class="k">return</span> <span class="n">f</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">'rb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="n">tbl</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">if</span> <span class="n">r</span> <span class="k">else</span> <span class="mf">0.0</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">row</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Make some random table out of thin air...</span>
        <span class="n">tbl</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="n">compat_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rows</span><span class="p">):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">_j</span> <span class="ow">in</span> <span class="n">compat_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cols</span><span class="p">):</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
            <span class="n">tbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="c1"># Generate the work to be done.</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">make_flow</span><span class="p">(</span><span class="n">tbl</span><span class="p">)</span>

    <span class="c1"># Now run it (using the specified executor)...</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">executor</span> <span class="o">=</span> <span class="n">futurist</span><span class="o">.</span><span class="n">GreenThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="c1"># No eventlet currently active, use real threads instead.</span>
        <span class="n">executor</span> <span class="o">=</span> <span class="n">futurist</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'parallel'</span><span class="p">,</span> <span class="n">executor</span><span class="o">=</span><span class="n">executor</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">run_iter</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>

    <span class="c1"># Find the old rows and put them into place...</span>
    <span class="c1">#</span>
    <span class="c1"># TODO(harlowja): probably easier just to sort instead of search...</span>
    <span class="n">computed_tbl</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">compat_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">computed_tbl</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

    <span class="c1"># Do some basic validation (which causes the return code of this process</span>
    <span class="c1"># to be different if things were not as expected...)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">computed_tbl</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tbl</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="linear-equation-solver-explicit-dependencies">
<h1>Linear equation solver (explicit dependencies)<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#linear-equation-solver-explicit-dependencies" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/calculate_linear.py">calculate_linear</a>.</p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">taskflow.engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>


<span class="c1"># INTRO: In this example a linear flow is used to group four tasks to calculate</span>
<span class="c1"># a value. A single added task is used twice, showing how this can be done</span>
<span class="c1"># and the twice added task takes in different bound values. In the first case</span>
<span class="c1"># it uses default parameters ('x' and 'y') and in the second case arguments</span>
<span class="c1"># are bound with ('z', 'd') keys from the engines internal storage mechanism.</span>
<span class="c1">#</span>
<span class="c1"># A multiplier task uses a binding that another task also provides, but this</span>
<span class="c1"># example explicitly shows that 'z' parameter is bound with 'a' key</span>
<span class="c1"># This shows that if a task depends on a key named the same as a key provided</span>
<span class="c1"># from another task the name can be remapped to take the desired key from a</span>
<span class="c1"># different origin.</span>


<span class="c1"># This task provides some values from as a result of execution, this can be</span>
<span class="c1"># useful when you want to provide values from a static set to other tasks that</span>
<span class="c1"># depend on those values existing before those tasks can run.</span>
<span class="c1">#</span>
<span class="c1"># NOTE(harlowja): this usage is *depreciated* in favor of a simpler mechanism</span>
<span class="c1"># that just provides those values on engine running by prepopulating the</span>
<span class="c1"># storage backend before your tasks are ran (which accomplishes a similar goal</span>
<span class="c1"># in a more uniform manner).</span>
<span class="k">class</span> <span class="nc">Provider</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Provider</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_provide</span> <span class="o">=</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_provide</span>


<span class="c1"># This task adds two input variables and returns the result.</span>
<span class="c1">#</span>
<span class="c1"># Note that since this task does not have a revert() function (since addition</span>
<span class="c1"># is a stateless operation) there are no side-effects that this function needs</span>
<span class="c1"># to undo if some later operation fails.</span>
<span class="k">class</span> <span class="nc">Adder</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>


<span class="c1"># This task multiplies an input variable by a multiplier and returns the</span>
<span class="c1"># result.</span>
<span class="c1">#</span>
<span class="c1"># Note that since this task does not have a revert() function (since</span>
<span class="c1"># multiplication is a stateless operation) and there are no side-effects that</span>
<span class="c1"># this function needs to undo if some later operation fails.</span>
<span class="k">class</span> <span class="nc">Multiplier</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">rebind</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Multiplier</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="n">provides</span><span class="p">,</span>
                                         <span class="n">rebind</span><span class="o">=</span><span class="n">rebind</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_multiplier</span> <span class="o">=</span> <span class="n">multiplier</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">z</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_multiplier</span>


<span class="c1"># Note here that the ordering is established so that the correct sequences</span>
<span class="c1"># of operations occurs where the adding and multiplying is done according</span>
<span class="c1"># to the expected and typical mathematical model. A graph flow could also be</span>
<span class="c1"># used here to automatically infer &amp; ensure the correct ordering.</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'root'</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="c1"># Provide the initial values for other tasks to depend on.</span>
    <span class="c1">#</span>
    <span class="c1"># x = 2, y = 3, d = 5</span>
    <span class="n">Provider</span><span class="p">(</span><span class="s2">"provide-adder"</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="s1">'y'</span><span class="p">,</span> <span class="s1">'d'</span><span class="p">)),</span>
    <span class="c1"># z = x+y = 5</span>
    <span class="n">Adder</span><span class="p">(</span><span class="s2">"add-1"</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'z'</span><span class="p">),</span>
    <span class="c1"># a = z+d = 10</span>
    <span class="n">Adder</span><span class="p">(</span><span class="s2">"add-2"</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'a'</span><span class="p">,</span> <span class="n">rebind</span><span class="o">=</span><span class="p">[</span><span class="s1">'z'</span><span class="p">,</span> <span class="s1">'d'</span><span class="p">]),</span>
    <span class="c1"># Calculate 'r = a*3 = 30'</span>
    <span class="c1">#</span>
    <span class="c1"># Note here that the 'z' argument of the execute() function will not be</span>
    <span class="c1"># bound to the 'z' variable provided from the above 'provider' object but</span>
    <span class="c1"># instead the 'z' argument will be taken from the 'a' variable provided</span>
    <span class="c1"># by the second add-2 listed above.</span>
    <span class="n">Multiplier</span><span class="p">(</span><span class="s2">"multi"</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">rebind</span><span class="o">=</span><span class="p">{</span><span class="s1">'z'</span><span class="p">:</span> <span class="s1">'a'</span><span class="p">})</span>
<span class="p">)</span>

<span class="c1"># The result here will be all results (from all tasks) which is stored in an</span>
<span class="c1"># in-memory storage location that backs this engine since it is not configured</span>
<span class="c1"># with persistence storage.</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">taskflow</span><span class="o">.</span><span class="n">engines</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="linear-equation-solver-inferred-dependencies">
<h1>Linear equation solver (inferred dependencies)<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#linear-equation-solver-inferred-dependencies" title="Permalink to this headline">¶</a></h1>
<p><code class="docutils literal"><span class="pre">Source:</span></code> <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/graph_flow.py.py">graph_flow.py</a></p>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">taskflow.engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">graph_flow</span> <span class="k">as</span> <span class="n">gf</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>


<span class="c1"># In this example there are complex *inferred* dependencies between tasks that</span>
<span class="c1"># are used to perform a simple set of linear equations.</span>
<span class="c1">#</span>
<span class="c1"># As you will see below the tasks just define what they require as input</span>
<span class="c1"># and produce as output (named values). Then the user doesn't care about</span>
<span class="c1"># ordering the tasks (in this case the tasks calculate pieces of the overall</span>
<span class="c1"># equation).</span>
<span class="c1">#</span>
<span class="c1"># As you will notice a graph flow resolves dependencies automatically using the</span>
<span class="c1"># tasks symbol requirements and provided symbol values and no orderin</span>
<span class="c1"># dependency has to be manually created.</span>
<span class="c1">#</span>
<span class="c1"># Also notice that flows of any types can be nested into a graph flow; showing</span>
<span class="c1"># that subflow dependencies (and associated ordering) will be inferred too.</span>


<span class="k">class</span> <span class="nc">Adder</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>


<span class="n">flow</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'root'</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'nested_linear'</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="c1"># x2 = y3+y4 = 12</span>
        <span class="n">Adder</span><span class="p">(</span><span class="s2">"add2"</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'x2'</span><span class="p">,</span> <span class="n">rebind</span><span class="o">=</span><span class="p">[</span><span class="s1">'y3'</span><span class="p">,</span> <span class="s1">'y4'</span><span class="p">]),</span>
        <span class="c1"># x1 = y1+y2 = 4</span>
        <span class="n">Adder</span><span class="p">(</span><span class="s2">"add1"</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'x1'</span><span class="p">,</span> <span class="n">rebind</span><span class="o">=</span><span class="p">[</span><span class="s1">'y1'</span><span class="p">,</span> <span class="s1">'y2'</span><span class="p">])</span>
    <span class="p">),</span>
    <span class="c1"># x5 = x1+x3 = 20</span>
    <span class="n">Adder</span><span class="p">(</span><span class="s2">"add5"</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'x5'</span><span class="p">,</span> <span class="n">rebind</span><span class="o">=</span><span class="p">[</span><span class="s1">'x1'</span><span class="p">,</span> <span class="s1">'x3'</span><span class="p">]),</span>
    <span class="c1"># x3 = x1+x2 = 16</span>
    <span class="n">Adder</span><span class="p">(</span><span class="s2">"add3"</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'x3'</span><span class="p">,</span> <span class="n">rebind</span><span class="o">=</span><span class="p">[</span><span class="s1">'x1'</span><span class="p">,</span> <span class="s1">'x2'</span><span class="p">]),</span>
    <span class="c1"># x4 = x2+y5 = 21</span>
    <span class="n">Adder</span><span class="p">(</span><span class="s2">"add4"</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'x4'</span><span class="p">,</span> <span class="n">rebind</span><span class="o">=</span><span class="p">[</span><span class="s1">'x2'</span><span class="p">,</span> <span class="s1">'y5'</span><span class="p">]),</span>
    <span class="c1"># x6 = x5+x4 = 41</span>
    <span class="n">Adder</span><span class="p">(</span><span class="s2">"add6"</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'x6'</span><span class="p">,</span> <span class="n">rebind</span><span class="o">=</span><span class="p">[</span><span class="s1">'x5'</span><span class="p">,</span> <span class="s1">'x4'</span><span class="p">]),</span>
    <span class="c1"># x7 = x6+x6 = 82</span>
    <span class="n">Adder</span><span class="p">(</span><span class="s2">"add7"</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'x7'</span><span class="p">,</span> <span class="n">rebind</span><span class="o">=</span><span class="p">[</span><span class="s1">'x6'</span><span class="p">,</span> <span class="s1">'x6'</span><span class="p">]))</span>

<span class="c1"># Provide the initial variable inputs using a storage dictionary.</span>
<span class="n">store</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"y1"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">"y2"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">"y3"</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s2">"y4"</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s2">"y5"</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># This is the expected values that should be created.</span>
<span class="n">unexpected</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">expected</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">'x1'</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'x2'</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'x3'</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'x4'</span><span class="p">,</span> <span class="mi">21</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'x5'</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'x6'</span><span class="p">,</span> <span class="mi">41</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">'x7'</span><span class="p">,</span> <span class="mi">82</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">taskflow</span><span class="o">.</span><span class="n">engines</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">flow</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'serial'</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"Single threaded engine result </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">result</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">actual</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> != </span><span class="si">%s</span><span class="se">\n</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="n">unexpected</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">result</span> <span class="o">=</span> <span class="n">taskflow</span><span class="o">.</span><span class="n">engines</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">flow</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'parallel'</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">"Multi threaded engine result </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">result</span><span class="p">)</span>
<span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">expected</span><span class="p">:</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">actual</span> <span class="o">!=</span> <span class="n">value</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> != </span><span class="si">%s</span><span class="se">\n</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">actual</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
        <span class="n">unexpected</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="k">if</span> <span class="n">unexpected</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="linear-equation-solver-in-parallel">
<h1>Linear equation solver (in parallel)<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#linear-equation-solver-in-parallel" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/calculate_in_parallel.py">calculate_in_parallel</a></p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">taskflow.engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">unordered_flow</span> <span class="k">as</span> <span class="n">uf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>

<span class="c1"># INTRO: These examples show how a linear flow and an unordered flow can be</span>
<span class="c1"># used together to execute calculations in parallel and then use the</span>
<span class="c1"># result for the next task/s. The adder task is used for all calculations</span>
<span class="c1"># and argument bindings are used to set correct parameters for each task.</span>


<span class="c1"># This task provides some values from as a result of execution, this can be</span>
<span class="c1"># useful when you want to provide values from a static set to other tasks that</span>
<span class="c1"># depend on those values existing before those tasks can run.</span>
<span class="c1">#</span>
<span class="c1"># NOTE(harlowja): this usage is *depreciated* in favor of a simpler mechanism</span>
<span class="c1"># that provides those values on engine running by prepopulating the storage</span>
<span class="c1"># backend before your tasks are ran (which accomplishes a similar goal in a</span>
<span class="c1"># more uniform manner).</span>
<span class="k">class</span> <span class="nc">Provider</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Provider</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_provide</span> <span class="o">=</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_provide</span>


<span class="c1"># This task adds two input variables and returns the result of that addition.</span>
<span class="c1">#</span>
<span class="c1"># Note that since this task does not have a revert() function (since addition</span>
<span class="c1"># is a stateless operation) there are no side-effects that this function needs</span>
<span class="c1"># to undo if some later operation fails.</span>
<span class="k">class</span> <span class="nc">Adder</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>


<span class="n">flow</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'root'</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="c1"># Provide the initial values for other tasks to depend on.</span>
    <span class="c1">#</span>
    <span class="c1"># x1 = 2, y1 = 3, x2 = 5, x3 = 8</span>
    <span class="n">Provider</span><span class="p">(</span><span class="s2">"provide-adder"</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span>
             <span class="n">provides</span><span class="o">=</span><span class="p">(</span><span class="s1">'x1'</span><span class="p">,</span> <span class="s1">'y1'</span><span class="p">,</span> <span class="s1">'x2'</span><span class="p">,</span> <span class="s1">'y2'</span><span class="p">)),</span>
    <span class="c1"># Note here that we define the flow that contains the 2 adders to be an</span>
    <span class="c1"># unordered flow since the order in which these execute does not matter,</span>
    <span class="c1"># another way to solve this would be to use a graph_flow pattern, which</span>
    <span class="c1"># also can run in parallel (since they have no ordering dependencies).</span>
    <span class="n">uf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'adders'</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="c1"># Calculate 'z1 = x1+y1 = 5'</span>
        <span class="c1">#</span>
        <span class="c1"># Rebind here means that the execute() function x argument will be</span>
        <span class="c1"># satisfied from a previous output named 'x1', and the y argument</span>
        <span class="c1"># of execute() will be populated from the previous output named 'y1'</span>
        <span class="c1">#</span>
        <span class="c1"># The output (result of adding) will be mapped into a variable named</span>
        <span class="c1"># 'z1' which can then be refereed to and depended on by other tasks.</span>
        <span class="n">Adder</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"add"</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'z1'</span><span class="p">,</span> <span class="n">rebind</span><span class="o">=</span><span class="p">[</span><span class="s1">'x1'</span><span class="p">,</span> <span class="s1">'y1'</span><span class="p">]),</span>
        <span class="c1"># z2 = x2+y2 = 13</span>
        <span class="n">Adder</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"add-2"</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'z2'</span><span class="p">,</span> <span class="n">rebind</span><span class="o">=</span><span class="p">[</span><span class="s1">'x2'</span><span class="p">,</span> <span class="s1">'y2'</span><span class="p">]),</span>
    <span class="p">),</span>
    <span class="c1"># r = z1+z2 = 18</span>
    <span class="n">Adder</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"sum-1"</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'r'</span><span class="p">,</span> <span class="n">rebind</span><span class="o">=</span><span class="p">[</span><span class="s1">'z1'</span><span class="p">,</span> <span class="s1">'z2'</span><span class="p">]))</span>


<span class="c1"># The result here will be all results (from all tasks) which is stored in an</span>
<span class="c1"># in-memory storage location that backs this engine since it is not configured</span>
<span class="c1"># with persistence storage.</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">taskflow</span><span class="o">.</span><span class="n">engines</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'parallel'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="creating-a-volume-in-parallel">
<h1>Creating a volume (in parallel)<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#creating-a-volume-in-parallel" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/create_parallel_volume.py">create_parallel_volume</a></p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">reflection</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.listeners</span> <span class="kn">import</span> <span class="n">printing</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">unordered_flow</span> <span class="k">as</span> <span class="n">uf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>

<span class="c1"># INTRO: These examples show how unordered_flow can be used to create a large</span>
<span class="c1"># number of fake volumes in parallel (or serially, depending on a constant that</span>
<span class="c1"># can be easily changed).</span>


<span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">show_time</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">yield</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">" -- </span><span class="si">%s</span><span class="s2"> took </span><span class="si">%0.3f</span><span class="s2"> seconds"</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span>


<span class="c1"># This affects how many volumes to create and how much time to *simulate*</span>
<span class="c1"># passing for that volume to be created.</span>
<span class="n">MAX_CREATE_TIME</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">VOLUME_COUNT</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># This will be used to determine if all the volumes are created in parallel</span>
<span class="c1"># or whether the volumes are created serially (in an undefined ordered since</span>
<span class="c1"># a unordered flow is used). Note that there is a disconnection between the</span>
<span class="c1"># ordering and the concept of parallelism (since unordered items can still be</span>
<span class="c1"># ran in a serial ordering). A typical use-case for offering both is to allow</span>
<span class="c1"># for debugging using a serial approach, while when running at a larger scale</span>
<span class="c1"># one would likely want to use the parallel approach.</span>
<span class="c1">#</span>
<span class="c1"># If you switch this flag from serial to parallel you can see the overall</span>
<span class="c1"># time difference that this causes.</span>
<span class="n">SERIAL</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">if</span> <span class="n">SERIAL</span><span class="p">:</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="s1">'serial'</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="s1">'parallel'</span>


<span class="k">class</span> <span class="nc">VolumeCreator</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_id</span><span class="p">):</span>
        <span class="c1"># Note here that the volume name is composed of the name of the class</span>
        <span class="c1"># along with the volume id that is being created, since a name of a</span>
        <span class="c1"># task uniquely identifies that task in storage it is important that</span>
        <span class="c1"># the name be relevant and identifiable if the task is recreated for</span>
        <span class="c1"># subsequent resumption (if applicable).</span>
        <span class="c1">#</span>
        <span class="c1"># UUIDs are *not* used as they can not be tied back to a previous tasks</span>
        <span class="c1"># state on resumption (since they are unique and will vary for each</span>
        <span class="c1"># task that is created). A name based off the volume id that is to be</span>
        <span class="c1"># created is more easily tied back to the original task so that the</span>
        <span class="c1"># volume create can be resumed/revert, and is much easier to use for</span>
        <span class="c1"># audit and tracking purposes.</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="n">reflection</span><span class="o">.</span><span class="n">get_callable_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">VolumeCreator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">base_name</span><span class="p">,</span>
                                                            <span class="n">volume_id</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_volume_id</span> <span class="o">=</span> <span class="n">volume_id</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Making volume </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_volume_id</span><span class="p">))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="n">MAX_CREATE_TIME</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Finished making volume </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_volume_id</span><span class="p">))</span>


<span class="c1"># Assume there is no ordering dependency between volumes.</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">uf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"volume-maker"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">VOLUME_COUNT</span><span class="p">):</span>
    <span class="n">flow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">VolumeCreator</span><span class="p">(</span><span class="n">volume_id</span><span class="o">=</span><span class="s2">"vol-</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)))</span>


<span class="c1"># Show how much time the overall engine loading and running takes.</span>
<span class="k">with</span> <span class="n">show_time</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">flow</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">title</span><span class="p">()):</span>
    <span class="n">eng</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>
    <span class="c1"># This context manager automatically adds (and automatically removes) a</span>
    <span class="c1"># helpful set of state transition notification printing helper utilities</span>
    <span class="c1"># that show you exactly what transitions the engine is going through</span>
    <span class="c1"># while running the various volume create tasks.</span>
    <span class="k">with</span> <span class="n">printing</span><span class="o">.</span><span class="n">PrintingListener</span><span class="p">(</span><span class="n">eng</span><span class="p">):</span>
        <span class="n">eng</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="summation-mapper-s-and-reducer-in-parallel">
<h1>Summation mapper(s) and reducer (in parallel)<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#summation-mapper-s-and-reducer-in-parallel" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/simple_map_reduce.py">simple_map_reduce</a></p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">self_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">self_dir</span><span class="p">)</span>

<span class="c1"># INTRO: These examples show a simplistic map/reduce implementation where</span>
<span class="c1"># a set of mapper(s) will sum a series of input numbers (in parallel) and</span>
<span class="c1"># return their individual summed result. A reducer will then use those</span>
<span class="c1"># produced values and perform a final summation and this result will then be</span>
<span class="c1"># printed (and verified to ensure the calculation was as expected).</span>

<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">unordered_flow</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>


<span class="k">class</span> <span class="nc">SumMapper</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="c1"># Sums some set of provided inputs.</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">TotalReducer</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Reduces all mapped summed outputs into a single value.</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="c1"># If any other kwargs was passed in, we don't want to use those</span>
            <span class="c1"># in the calculation of the total...</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">'reduction_'</span><span class="p">):</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">total</span>


<span class="k">def</span> <span class="nf">chunk_iter</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">,</span> <span class="n">upperbound</span><span class="p">):</span>
    <span class="sd">"""Yields back chunk size pieces from zero to upperbound - 1."""</span>
    <span class="n">chunk</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">upperbound</span><span class="p">):</span>
        <span class="n">chunk</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">==</span> <span class="n">chunk_size</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">chunk</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="p">[]</span>


<span class="c1"># Upper bound of numbers to sum for example purposes...</span>
<span class="n">UPPER_BOUND</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="c1"># How many mappers we want to have.</span>
<span class="n">SPLIT</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># How big of a chunk we want to give each mapper.</span>
<span class="n">CHUNK_SIZE</span> <span class="o">=</span> <span class="n">UPPER_BOUND</span> <span class="o">//</span> <span class="n">SPLIT</span>

<span class="c1"># This will be the workflow we will compose and run.</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">linear_flow</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"root"</span><span class="p">)</span>

<span class="c1"># The mappers will run in parallel.</span>
<span class="n">store</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">provided</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">mappers</span> <span class="o">=</span> <span class="n">unordered_flow</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'map'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chunk_iter</span><span class="p">(</span><span class="n">CHUNK_SIZE</span><span class="p">,</span> <span class="n">UPPER_BOUND</span><span class="p">)):</span>
    <span class="n">mapper_name</span> <span class="o">=</span> <span class="s1">'mapper_</span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="n">i</span>
    <span class="c1"># Give that mapper some information to compute.</span>
    <span class="n">store</span><span class="p">[</span><span class="n">mapper_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">chunk</span>
    <span class="c1"># The reducer uses all of the outputs of the mappers, so it needs</span>
    <span class="c1"># to be recorded that it needs access to them (under a specific name).</span>
    <span class="n">provided</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"reduction_</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
    <span class="n">mappers</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">SumMapper</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">mapper_name</span><span class="p">,</span>
                          <span class="n">rebind</span><span class="o">=</span><span class="p">{</span><span class="s1">'inputs'</span><span class="p">:</span> <span class="n">mapper_name</span><span class="p">},</span>
                          <span class="n">provides</span><span class="o">=</span><span class="n">provided</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">w</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mappers</span><span class="p">)</span>

<span class="c1"># The reducer will run last (after all the mappers).</span>
<span class="n">w</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">TotalReducer</span><span class="p">(</span><span class="s1">'reducer'</span><span class="p">,</span> <span class="n">requires</span><span class="o">=</span><span class="n">provided</span><span class="p">))</span>

<span class="c1"># Now go!</span>
<span class="n">e</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'parallel'</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">,</span> <span class="n">max_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"Running a parallel engine with options: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">e</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
<span class="n">e</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># Now get the result the reducer created.</span>
<span class="n">total</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'reducer'</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="s2">"Calculated result = </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">total</span><span class="p">)</span>

<span class="c1"># Calculate it manually to verify that it worked...</span>
<span class="n">calc_total</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">UPPER_BOUND</span><span class="p">))</span>
<span class="k">if</span> <span class="n">calc_total</span> <span class="o">!=</span> <span class="n">total</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="sharing-a-thread-pool-executor-in-parallel">
<h1>Sharing a thread pool executor (in parallel)<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#sharing-a-thread-pool-executor-in-parallel" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/share_engine_thread.py">share_engine_thread</a></p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">futurist</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">unordered_flow</span> <span class="k">as</span> <span class="n">uf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>
<span class="kn">from</span> <span class="nn">taskflow.utils</span> <span class="kn">import</span> <span class="n">threading_utils</span> <span class="k">as</span> <span class="n">tu</span>

<span class="c1"># INTRO: in this example we create 2 dummy flow(s) with a 2 dummy task(s), and</span>
<span class="c1"># run it using a shared thread pool executor to show how a single executor can</span>
<span class="c1"># be used with more than one engine (sharing the execution thread pool between</span>
<span class="c1"># them); this allows for saving resources and reusing threads in situations</span>
<span class="c1"># where this is benefical.</span>


<span class="k">class</span> <span class="nc">DelayedTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DelayedTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Running '</span><span class="si">%s</span><span class="s2">' in thread '</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">tu</span><span class="o">.</span><span class="n">get_ident</span><span class="p">()))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_wait_for</span><span class="p">)</span>


<span class="n">f1</span> <span class="o">=</span> <span class="n">uf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"f1"</span><span class="p">)</span>
<span class="n">f1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">DelayedTask</span><span class="p">(</span><span class="s2">"f1-1"</span><span class="p">))</span>
<span class="n">f1</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">DelayedTask</span><span class="p">(</span><span class="s2">"f1-2"</span><span class="p">))</span>

<span class="n">f2</span> <span class="o">=</span> <span class="n">uf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"f2"</span><span class="p">)</span>
<span class="n">f2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">DelayedTask</span><span class="p">(</span><span class="s2">"f2-1"</span><span class="p">))</span>
<span class="n">f2</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">DelayedTask</span><span class="p">(</span><span class="s2">"f2-2"</span><span class="p">))</span>

<span class="c1"># Run them all using the same futures (thread-pool based) executor...</span>
<span class="k">with</span> <span class="n">futurist</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="n">e1</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f1</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'parallel'</span><span class="p">,</span> <span class="n">executor</span><span class="o">=</span><span class="n">ex</span><span class="p">)</span>
    <span class="n">e2</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f2</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'parallel'</span><span class="p">,</span> <span class="n">executor</span><span class="o">=</span><span class="n">ex</span><span class="p">)</span>
    <span class="n">iters</span> <span class="o">=</span> <span class="p">[</span><span class="n">e1</span><span class="o">.</span><span class="n">run_iter</span><span class="p">(),</span> <span class="n">e2</span><span class="o">.</span><span class="n">run_iter</span><span class="p">()]</span>
    <span class="c1"># Iterate over a copy (so we can remove from the source list).</span>
    <span class="n">cloned_iters</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">iters</span><span class="p">)</span>
    <span class="k">while</span> <span class="n">iters</span><span class="p">:</span>
        <span class="c1"># Run a single 'step' of each iterator, forcing each engine to perform</span>
        <span class="c1"># some work, then yield, and repeat until each iterator is consumed</span>
        <span class="c1"># and there is no more engine work to be done.</span>
        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">cloned_iters</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">six</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">iters</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="storing-emitting-a-bill">
<h1>Storing &amp; emitting a bill<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#storing-emitting-a-bill" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/fake_billing.py">fake_billing</a></p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">uuidutils</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.listeners</span> <span class="kn">import</span> <span class="n">printing</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">graph_flow</span> <span class="k">as</span> <span class="n">gf</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>
<span class="kn">from</span> <span class="nn">taskflow.utils</span> <span class="kn">import</span> <span class="n">misc</span>

<span class="c1"># INTRO: This example walks through a miniature workflow which simulates</span>
<span class="c1"># the reception of an API request, creation of a database entry, driver</span>
<span class="c1"># activation (which invokes a 'fake' webservice) and final completion.</span>
<span class="c1">#</span>
<span class="c1"># This example also shows how a function/object (in this class the url sending)</span>
<span class="c1"># that occurs during driver activation can update the progress of a task</span>
<span class="c1"># without being aware of the internals of how to do this by associating a</span>
<span class="c1"># callback that the url sending can update as the sending progresses from 0.0%</span>
<span class="c1"># complete to 100% complete.</span>


<span class="k">class</span> <span class="nc">DB</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sql</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Querying with: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">sql</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">UrlCaller</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_send_time</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chunks</span> <span class="o">=</span> <span class="mi">25</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">status_cb</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">sleep_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_send_time</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chunks</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)):</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_time</span><span class="p">)</span>
            <span class="c1"># As we send the data, each chunk we 'fake' send will progress</span>
            <span class="c1"># the sending progress that much further to 100%.</span>
            <span class="k">if</span> <span class="n">status_cb</span><span class="p">:</span>
                <span class="n">status_cb</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>


<span class="c1"># Since engines save the output of tasks to a optional persistent storage</span>
<span class="c1"># backend resources have to be dealt with in a slightly different manner since</span>
<span class="c1"># resources are transient and can *not* be persisted (or serialized). For tasks</span>
<span class="c1"># that require access to a set of resources it is a common pattern to provide</span>
<span class="c1"># a object (in this case this object) on construction of those tasks via the</span>
<span class="c1"># task constructor.</span>
<span class="k">class</span> <span class="nc">ResourceFetcher</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db_handle</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_url_handle</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">db_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_handle</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db_handle</span> <span class="o">=</span> <span class="n">DB</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db_handle</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">url_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url_handle</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_url_handle</span> <span class="o">=</span> <span class="n">UrlCaller</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url_handle</span>


<span class="k">class</span> <span class="nc">ExtractInputRequest</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ExtractInputRequest</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">provides</span><span class="o">=</span><span class="s2">"parsed_request"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span> <span class="o">=</span> <span class="n">resources</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">'user'</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="s1">'user_id'</span><span class="p">:</span> <span class="n">misc</span><span class="o">.</span><span class="n">as_int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
            <span class="s1">'request_id'</span><span class="p">:</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">(),</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">MakeDBEntry</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MakeDBEntry</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span> <span class="o">=</span> <span class="n">resources</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parsed_request</span><span class="p">):</span>
        <span class="n">db_handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span><span class="o">.</span><span class="n">db_handle</span>
        <span class="n">db_handle</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">"INSERT </span><span class="si">%s</span><span class="s2"> INTO mydb"</span> <span class="o">%</span> <span class="p">(</span><span class="n">parsed_request</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">revert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">parsed_request</span><span class="p">):</span>
        <span class="n">db_handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span><span class="o">.</span><span class="n">db_handle</span>
        <span class="n">db_handle</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">"DELETE </span><span class="si">%s</span><span class="s2"> FROM mydb IF EXISTS"</span> <span class="o">%</span> <span class="p">(</span><span class="n">parsed_request</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">ActivateDriver</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ActivateDriver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">provides</span><span class="o">=</span><span class="s1">'sent_to'</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span> <span class="o">=</span> <span class="n">resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_url</span> <span class="o">=</span> <span class="s2">"http://blahblah.com"</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parsed_request</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Sending billing data to </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">))</span>
        <span class="n">url_sender</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resources</span><span class="o">.</span><span class="n">url_handle</span>
        <span class="c1"># Note that here we attach our update_progress function (which is a</span>
        <span class="c1"># function that the engine also 'binds' to) to the progress function</span>
        <span class="c1"># that the url sending helper class uses. This allows the task progress</span>
        <span class="c1"># to be tied to the url sending progress, which is very useful for</span>
        <span class="c1"># downstream systems to be aware of what a task is doing at any time.</span>
        <span class="n">url_sender</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_url</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">parsed_request</span><span class="p">),</span>
                        <span class="n">status_cb</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">update_progress</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_url</span>

    <span class="k">def</span> <span class="nf">update_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Override the parent method to also print out the status.</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ActivateDriver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">update_progress</span><span class="p">(</span><span class="n">progress</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> is </span><span class="si">%0.2f%%</span><span class="s2"> done"</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">progress</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">DeclareSuccess</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sent_to</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Done!"</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"All data processed and sent to </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">sent_to</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">DummyUser</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">id_</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id_</span>


<span class="c1"># Resources (db handles and similar) of course can *not* be persisted so we</span>
<span class="c1"># need to make sure that we pass this resource fetcher to the tasks constructor</span>
<span class="c1"># so that the tasks have access to any needed resources (the resources are</span>
<span class="c1"># lazily loaded so that they are only created when they are used).</span>
<span class="n">resources</span> <span class="o">=</span> <span class="n">ResourceFetcher</span><span class="p">()</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"initialize-me"</span><span class="p">)</span>

<span class="c1"># 1. First we extract the api request into a usable format.</span>
<span class="c1"># 2. Then we go ahead and make a database entry for our request.</span>
<span class="n">flow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ExtractInputRequest</span><span class="p">(</span><span class="n">resources</span><span class="p">),</span> <span class="n">MakeDBEntry</span><span class="p">(</span><span class="n">resources</span><span class="p">))</span>

<span class="c1"># 3. Then we activate our payment method and finally declare success.</span>
<span class="n">sub_flow</span> <span class="o">=</span> <span class="n">gf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"after-initialize"</span><span class="p">)</span>
<span class="n">sub_flow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ActivateDriver</span><span class="p">(</span><span class="n">resources</span><span class="p">),</span> <span class="n">DeclareSuccess</span><span class="p">())</span>
<span class="n">flow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">sub_flow</span><span class="p">)</span>

<span class="c1"># Initially populate the storage with the following request object,</span>
<span class="c1"># prepopulating this allows the tasks that dependent on the 'request' variable</span>
<span class="c1"># to start processing (in this case this is the ExtractInputRequest task).</span>
<span class="n">store</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'request'</span><span class="p">:</span> <span class="n">DummyUser</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s2">"bob"</span><span class="p">,</span> <span class="n">id_</span><span class="o">=</span><span class="s2">"1.35"</span><span class="p">),</span>
<span class="p">}</span>
<span class="n">eng</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'serial'</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">)</span>

<span class="c1"># This context manager automatically adds (and automatically removes) a</span>
<span class="c1"># helpful set of state transition notification printing helper utilities</span>
<span class="c1"># that show you exactly what transitions the engine is going through</span>
<span class="c1"># while running the various billing related tasks.</span>
<span class="k">with</span> <span class="n">printing</span><span class="o">.</span><span class="n">PrintingListener</span><span class="p">(</span><span class="n">eng</span><span class="p">):</span>
    <span class="n">eng</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="suspending-a-workflow-resuming">
<h1>Suspending a workflow &amp; resuming<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#suspending-a-workflow-resuming" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/resume_from_backend.py">resume_from_backend</a></p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">self_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">self_dir</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">uuidutils</span>

<span class="kn">import</span> <span class="nn">taskflow.engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow.persistence</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>

<span class="kn">import</span> <span class="nn">example_utils</span> <span class="kn">as</span> <span class="nn">eu</span>  <span class="c1"># noqa</span>

<span class="c1"># INTRO: In this example linear_flow is used to group three tasks, one which</span>
<span class="c1"># will suspend the future work the engine may do. This suspend engine is then</span>
<span class="c1"># discarded and the workflow is reloaded from the persisted data and then the</span>
<span class="c1"># workflow is resumed from where it was suspended. This allows you to see how</span>
<span class="c1"># to start an engine, have a task stop the engine from doing future work (if</span>
<span class="c1"># a multi-threaded engine is being used, then the currently active work is not</span>
<span class="c1"># preempted) and then resume the work later.</span>
<span class="c1">#</span>
<span class="c1"># Usage:</span>
<span class="c1">#</span>
<span class="c1">#   With a filesystem directory as backend</span>
<span class="c1">#</span>
<span class="c1">#     python taskflow/examples/resume_from_backend.py</span>
<span class="c1">#</span>
<span class="c1">#   With ZooKeeper as backend</span>
<span class="c1">#</span>
<span class="c1">#     python taskflow/examples/resume_from_backend.py \</span>
<span class="c1">#       zookeeper://127.0.0.1:2181/taskflow/resume_from_backend/</span>


<span class="c1"># UTILITY FUNCTIONS #########################################</span>


<span class="k">def</span> <span class="nf">print_task_states</span><span class="p">(</span><span class="n">flowdetail</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="n">eu</span><span class="o">.</span><span class="n">print_wrapped</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Flow '</span><span class="si">%s</span><span class="s2">' state: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">flowdetail</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">flowdetail</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>
    <span class="c1"># Sort by these so that our test validation doesn't get confused by the</span>
    <span class="c1"># order in which the items in the flow detail can be in.</span>
    <span class="n">items</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">td</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="n">td</span><span class="o">.</span><span class="n">results</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">td</span> <span class="ow">in</span> <span class="n">flowdetail</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">" </span><span class="si">%s</span><span class="s2">==</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">, result=</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">item</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">find_flow_detail</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">lb_id</span><span class="p">,</span> <span class="n">fd_id</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">get_connection</span><span class="p">()</span>
    <span class="n">lb</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">get_logbook</span><span class="p">(</span><span class="n">lb_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">lb</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">fd_id</span><span class="p">)</span>


<span class="c1"># CREATE FLOW ###############################################</span>


<span class="k">class</span> <span class="nc">InterruptTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># DO NOT TRY THIS AT HOME</span>
        <span class="n">engine</span><span class="o">.</span><span class="n">suspend</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">TestTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'executing </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">'ok'</span>


<span class="k">def</span> <span class="nf">flow_factory</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'resume from backend example'</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">TestTask</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'first'</span><span class="p">),</span>
        <span class="n">InterruptTask</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'boom'</span><span class="p">),</span>
        <span class="n">TestTask</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">'second'</span><span class="p">))</span>


<span class="c1"># INITIALIZE PERSISTENCE ####################################</span>

<span class="k">with</span> <span class="n">eu</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span> <span class="k">as</span> <span class="n">backend</span><span class="p">:</span>

    <span class="c1"># Create a place where the persistence information will be stored.</span>
    <span class="n">book</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">LogBook</span><span class="p">(</span><span class="s2">"example"</span><span class="p">)</span>
    <span class="n">flow_detail</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FlowDetail</span><span class="p">(</span><span class="s2">"resume from backend example"</span><span class="p">,</span>
                                    <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">())</span>
    <span class="n">book</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">flow_detail</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">get_connection</span><span class="p">())</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">save_logbook</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>

    <span class="c1"># CREATE AND RUN THE FLOW: FIRST ATTEMPT ####################</span>

    <span class="n">flow</span> <span class="o">=</span> <span class="n">flow_factory</span><span class="p">()</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">taskflow</span><span class="o">.</span><span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">flow_detail</span><span class="o">=</span><span class="n">flow_detail</span><span class="p">,</span>
                                   <span class="n">book</span><span class="o">=</span><span class="n">book</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">)</span>

    <span class="n">print_task_states</span><span class="p">(</span><span class="n">flow_detail</span><span class="p">,</span> <span class="s2">"At the beginning, there is no state"</span><span class="p">)</span>
    <span class="n">eu</span><span class="o">.</span><span class="n">print_wrapped</span><span class="p">(</span><span class="s2">"Running"</span><span class="p">)</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">print_task_states</span><span class="p">(</span><span class="n">flow_detail</span><span class="p">,</span> <span class="s2">"After running"</span><span class="p">)</span>

    <span class="c1"># RE-CREATE, RESUME, RUN ####################################</span>

    <span class="n">eu</span><span class="o">.</span><span class="n">print_wrapped</span><span class="p">(</span><span class="s2">"Resuming and running again"</span><span class="p">)</span>

    <span class="c1"># NOTE(harlowja): reload the flow detail from backend, this will allow us</span>
    <span class="c1"># to resume the flow from its suspended state, but first we need to search</span>
    <span class="c1"># for the right flow details in the correct logbook where things are</span>
    <span class="c1"># stored.</span>
    <span class="c1">#</span>
    <span class="c1"># We could avoid re-loading the engine and just do engine.run() again, but</span>
    <span class="c1"># this example shows how another process may unsuspend a given flow and</span>
    <span class="c1"># start it again for situations where this is useful to-do (say the process</span>
    <span class="c1"># running the above flow crashes).</span>
    <span class="n">flow2</span> <span class="o">=</span> <span class="n">flow_factory</span><span class="p">()</span>
    <span class="n">flow_detail_2</span> <span class="o">=</span> <span class="n">find_flow_detail</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">book</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span> <span class="n">flow_detail</span><span class="o">.</span><span class="n">uuid</span><span class="p">)</span>
    <span class="n">engine2</span> <span class="o">=</span> <span class="n">taskflow</span><span class="o">.</span><span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">flow2</span><span class="p">,</span>
                                    <span class="n">flow_detail</span><span class="o">=</span><span class="n">flow_detail_2</span><span class="p">,</span>
                                    <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="n">book</span><span class="p">)</span>
    <span class="n">engine2</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="n">print_task_states</span><span class="p">(</span><span class="n">flow_detail_2</span><span class="p">,</span> <span class="s2">"At the end"</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="creating-a-virtual-machine-resumable">
<h1>Creating a virtual machine (resumable)<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#creating-a-virtual-machine-resumable" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/resume_vm_boot.py">resume_vm_boot</a></p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">self_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">self_dir</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">futurist</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">uuidutils</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">exceptions</span> <span class="k">as</span> <span class="n">exc</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">graph_flow</span> <span class="k">as</span> <span class="n">gf</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow.persistence</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>

<span class="kn">import</span> <span class="nn">example_utils</span> <span class="kn">as</span> <span class="nn">eu</span>  <span class="c1"># noqa</span>

<span class="c1"># INTRO: These examples show how a hierarchy of flows can be used to create a</span>
<span class="c1"># vm in a reliable &amp; resumable manner using taskflow + a miniature version of</span>
<span class="c1"># what nova does while booting a vm.</span>


<span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">slow_down</span><span class="p">(</span><span class="n">how_long</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">how_long</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Only both to do this if user input provided.</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"** Ctrl-c me please!!! **"</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">how_long</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PrintText</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">"""Just inserts some text print outs in a workflow."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">print_what</span><span class="p">,</span> <span class="n">no_slow</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">content_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">print_what</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PrintText</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Print: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">content_hash</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text</span> <span class="o">=</span> <span class="n">print_what</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_slow</span> <span class="o">=</span> <span class="n">no_slow</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_slow</span><span class="p">:</span>
            <span class="n">eu</span><span class="o">.</span><span class="n">print_wrapped</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">slow_down</span><span class="p">():</span>
                <span class="n">eu</span><span class="o">.</span><span class="n">print_wrapped</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DefineVMSpec</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">"""Defines a vm specification to be."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DefineVMSpec</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">provides</span><span class="o">=</span><span class="s1">'vm_spec'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">'type'</span><span class="p">:</span> <span class="s1">'kvm'</span><span class="p">,</span>
            <span class="s1">'disks'</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
            <span class="s1">'vcpu'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'ips'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">'volumes'</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
        <span class="p">}</span>


<span class="k">class</span> <span class="nc">LocateImages</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">"""Locates where the vm images are."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LocateImages</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">provides</span><span class="o">=</span><span class="s1">'image_locations'</span><span class="p">,</span>
                                           <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_spec</span><span class="p">):</span>
        <span class="n">image_locations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vm_spec</span><span class="p">[</span><span class="s1">'disks'</span><span class="p">]):</span>
            <span class="n">url</span> <span class="o">=</span> <span class="s2">"http://www.yahoo.com/images/</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">image_locations</span><span class="p">[</span><span class="n">url</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"/tmp/</span><span class="si">%s</span><span class="s2">.img"</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">image_locations</span>


<span class="k">class</span> <span class="nc">DownloadImages</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">"""Downloads all the vm images."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DownloadImages</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">provides</span><span class="o">=</span><span class="s1">'download_paths'</span><span class="p">,</span>
                                             <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_locations</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">src</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="n">image_locations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">with</span> <span class="n">slow_down</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"Downloading from </span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">loc</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">image_locations</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">CreateNetworkTpl</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">"""Generates the network settings file to be placed in the images."""</span>
    <span class="n">SYSCONFIG_CONTENTS</span> <span class="o">=</span> <span class="s2">"""DEVICE=eth</span><span class="si">%s</span><span class="s2"></span>
<span class="s2">BOOTPROTO=static</span>
<span class="s2">IPADDR=</span><span class="si">%s</span><span class="s2"></span>
<span class="s2">ONBOOT=yes"""</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CreateNetworkTpl</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">provides</span><span class="o">=</span><span class="s1">'network_settings'</span><span class="p">,</span>
                                               <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ips</span><span class="p">):</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ip</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ips</span><span class="p">):</span>
            <span class="n">settings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SYSCONFIG_CONTENTS</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">ip</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">settings</span>


<span class="k">class</span> <span class="nc">AllocateIP</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">"""Allocates the ips for the given vm."""</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AllocateIP</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">provides</span><span class="o">=</span><span class="s1">'ips'</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_spec</span><span class="p">):</span>
        <span class="n">ips</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">_i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vm_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'ips'</span><span class="p">,</span> <span class="mi">0</span><span class="p">)):</span>
            <span class="n">ips</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"192.168.0.</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">254</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">ips</span>


<span class="k">class</span> <span class="nc">WriteNetworkSettings</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">"""Writes all the network settings into the downloaded images."""</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">download_paths</span><span class="p">,</span> <span class="n">network_settings</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">download_paths</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">slow_down</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"Mounting </span><span class="si">%s</span><span class="s2"> to /tmp/</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">setting</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">network_settings</span><span class="p">):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="p">(</span><span class="s2">"/tmp/etc/sysconfig/network-scripts/"</span>
                            <span class="s2">"ifcfg-eth</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">with</span> <span class="n">slow_down</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">"Writing to </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">))</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">setting</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BootVM</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">"""Fires off the vm boot operation."""</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_spec</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Starting vm!"</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">slow_down</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Created: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">vm_spec</span><span class="p">))</span>


<span class="k">class</span> <span class="nc">AllocateVolumes</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">"""Allocates the volumes for the vm."""</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vm_spec</span><span class="p">):</span>
        <span class="n">volumes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vm_spec</span><span class="p">[</span><span class="s1">'volumes'</span><span class="p">]):</span>
            <span class="k">with</span> <span class="n">slow_down</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">"/dev/vda</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"Allocated volume </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">volumes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">volumes</span>


<span class="k">class</span> <span class="nc">FormatVolumes</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">"""Formats the volumes for the vm."""</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volumes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">volumes</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Formatting volume </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">slow_down</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Formatted volume </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">v</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_flow</span><span class="p">():</span>
    <span class="c1"># Setup the set of things to do (mini-nova).</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"root"</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">PrintText</span><span class="p">(</span><span class="s2">"Starting vm creation."</span><span class="p">,</span> <span class="n">no_slow</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'vm-maker'</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="c1"># First create a specification for the final vm to-be.</span>
            <span class="n">DefineVMSpec</span><span class="p">(</span><span class="s2">"define_spec"</span><span class="p">),</span>
            <span class="c1"># This does all the image stuff.</span>
            <span class="n">gf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"img-maker"</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">LocateImages</span><span class="p">(</span><span class="s2">"locate_images"</span><span class="p">),</span>
                <span class="n">DownloadImages</span><span class="p">(</span><span class="s2">"download_images"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="c1"># This does all the network stuff.</span>
            <span class="n">gf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"net-maker"</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">AllocateIP</span><span class="p">(</span><span class="s2">"get_my_ips"</span><span class="p">),</span>
                <span class="n">CreateNetworkTpl</span><span class="p">(</span><span class="s2">"fetch_net_settings"</span><span class="p">),</span>
                <span class="n">WriteNetworkSettings</span><span class="p">(</span><span class="s2">"write_net_settings"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="c1"># This does all the volume stuff.</span>
            <span class="n">gf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"volume-maker"</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">AllocateVolumes</span><span class="p">(</span><span class="s2">"allocate_my_volumes"</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'volumes'</span><span class="p">),</span>
                <span class="n">FormatVolumes</span><span class="p">(</span><span class="s2">"volume_formatter"</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="c1"># Finally boot it all.</span>
            <span class="n">BootVM</span><span class="p">(</span><span class="s2">"boot-it"</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="c1"># Ya it worked!</span>
        <span class="n">PrintText</span><span class="p">(</span><span class="s2">"Finished vm create."</span><span class="p">,</span> <span class="n">no_slow</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
        <span class="n">PrintText</span><span class="p">(</span><span class="s2">"Instance is running!"</span><span class="p">,</span> <span class="n">no_slow</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">flow</span>

<span class="n">eu</span><span class="o">.</span><span class="n">print_wrapped</span><span class="p">(</span><span class="s2">"Initializing"</span><span class="p">)</span>

<span class="c1"># Setup the persistence &amp; resumption layer.</span>
<span class="k">with</span> <span class="n">eu</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span> <span class="k">as</span> <span class="n">backend</span><span class="p">:</span>

    <span class="c1"># Try to find a previously passed in tracking id...</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">book_id</span><span class="p">,</span> <span class="n">flow_id</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"+"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">is_uuid_like</span><span class="p">(</span><span class="n">book_id</span><span class="p">):</span>
            <span class="n">book_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">is_uuid_like</span><span class="p">(</span><span class="n">flow_id</span><span class="p">):</span>
            <span class="n">flow_id</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">book_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">flow_id</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Set up how we want our engine to run, serial, parallel...</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">executor</span> <span class="o">=</span> <span class="n">futurist</span><span class="o">.</span><span class="n">GreenThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="c1"># No eventlet installed, just let the default be used instead.</span>
        <span class="n">executor</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c1"># Create/fetch a logbook that will track the workflows work.</span>
    <span class="n">book</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">flow_detail</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">book_id</span><span class="p">,</span> <span class="n">flow_id</span><span class="p">]):</span>
        <span class="c1"># Try to find in a prior logbook and flow detail...</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">get_connection</span><span class="p">())</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">book</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">get_logbook</span><span class="p">(</span><span class="n">book_id</span><span class="p">)</span>
                <span class="n">flow_detail</span> <span class="o">=</span> <span class="n">book</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">flow_id</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">exc</span><span class="o">.</span><span class="n">NotFound</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">if</span> <span class="n">book</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">flow_detail</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">book</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">LogBook</span><span class="p">(</span><span class="s2">"vm-boot"</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">get_connection</span><span class="p">())</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">save_logbook</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load_from_factory</span><span class="p">(</span><span class="n">create_flow</span><span class="p">,</span>
                                           <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="n">book</span><span class="p">,</span>
                                           <span class="n">engine</span><span class="o">=</span><span class="s1">'parallel'</span><span class="p">,</span>
                                           <span class="n">executor</span><span class="o">=</span><span class="n">executor</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"!! Your tracking id is: '</span><span class="si">%s</span><span class="s2">+</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="p">(</span><span class="n">book</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                                   <span class="n">engine</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">flow_uuid</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"!! Please submit this on later runs for tracking purposes"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Attempt to load from a previously partially completed flow.</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load_from_detail</span><span class="p">(</span><span class="n">flow_detail</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
                                          <span class="n">engine</span><span class="o">=</span><span class="s1">'parallel'</span><span class="p">,</span> <span class="n">executor</span><span class="o">=</span><span class="n">executor</span><span class="p">)</span>

    <span class="c1"># Make me my vm please!</span>
    <span class="n">eu</span><span class="o">.</span><span class="n">print_wrapped</span><span class="p">(</span><span class="s1">'Running'</span><span class="p">)</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># How to use.</span>
<span class="c1">#</span>
<span class="c1"># 1. $ python me.py "sqlite:////tmp/nova.db"</span>
<span class="c1"># 2. ctrl-c before this finishes</span>
<span class="c1"># 3. Find the tracking id (search for 'Your tracking id is')</span>
<span class="c1"># 4. $ python me.py "sqlite:////tmp/cinder.db" "$tracking_id"</span>
<span class="c1"># 5. Watch it pick up where it left off.</span>
<span class="c1"># 6. Profit!</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="creating-a-volume-resumable">
<h1>Creating a volume (resumable)<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#creating-a-volume-resumable" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/resume_volume_create.py">resume_volume_create</a></p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">self_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">self_dir</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">uuidutils</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">graph_flow</span> <span class="k">as</span> <span class="n">gf</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow.persistence</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>

<span class="kn">import</span> <span class="nn">example_utils</span>  <span class="c1"># noqa</span>

<span class="c1"># INTRO: These examples show how a hierarchy of flows can be used to create a</span>
<span class="c1"># pseudo-volume in a reliable &amp; resumable manner using taskflow + a miniature</span>
<span class="c1"># version of what cinder does while creating a volume (very miniature).</span>


<span class="nd">@contextlib.contextmanager</span>
<span class="k">def</span> <span class="nf">slow_down</span><span class="p">(</span><span class="n">how_long</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">how_long</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"** Ctrl-c me please!!! **"</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">how_long</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">find_flow_detail</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">book_id</span><span class="p">,</span> <span class="n">flow_id</span><span class="p">):</span>
    <span class="c1"># NOTE(harlowja): this is used to attempt to find a given logbook with</span>
    <span class="c1"># a given id and a given flow details inside that logbook, we need this</span>
    <span class="c1"># reference so that we can resume the correct flow (as a logbook tracks</span>
    <span class="c1"># flows and a flow detail tracks a individual flow).</span>
    <span class="c1">#</span>
    <span class="c1"># Without a reference to the logbook and the flow details in that logbook</span>
    <span class="c1"># we will not know exactly what we should resume and that would mean we</span>
    <span class="c1"># can't resume what we don't know.</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">get_connection</span><span class="p">())</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="n">lb</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">get_logbook</span><span class="p">(</span><span class="n">book_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lb</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">flow_id</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PrintText</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">print_what</span><span class="p">,</span> <span class="n">no_slow</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">content_hash</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">print_what</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">'utf-8'</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PrintText</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"Print: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">content_hash</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_text</span> <span class="o">=</span> <span class="n">print_what</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_slow</span> <span class="o">=</span> <span class="n">no_slow</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_slow</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"-"</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">)))</span>
            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"-"</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">slow_down</span><span class="p">():</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"-"</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">)))</span>
                <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">)</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"-"</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_text</span><span class="p">)))</span>


<span class="k">class</span> <span class="nc">CreateSpecForVolumes</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">volumes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)):</span>
            <span class="n">volumes</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">'type'</span><span class="p">:</span> <span class="s1">'disk'</span><span class="p">,</span>
                <span class="s1">'location'</span><span class="p">:</span> <span class="s2">"/dev/vda</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">volumes</span>


<span class="k">class</span> <span class="nc">PrepareVolumes</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_specs</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">volume_specs</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">slow_down</span><span class="p">():</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"Dusting off your hard drive </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">))</span>
            <span class="k">with</span> <span class="n">slow_down</span><span class="p">():</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"Taking a well deserved break."</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Your drive </span><span class="si">%s</span><span class="s2"> has been certified."</span> <span class="o">%</span> <span class="p">(</span><span class="n">v</span><span class="p">))</span>


<span class="c1"># Setup the set of things to do (mini-cinder).</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"root"</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
    <span class="n">PrintText</span><span class="p">(</span><span class="s2">"Starting volume create"</span><span class="p">,</span> <span class="n">no_slow</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">gf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'maker'</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">CreateSpecForVolumes</span><span class="p">(</span><span class="s2">"volume_specs"</span><span class="p">,</span> <span class="n">provides</span><span class="o">=</span><span class="s1">'volume_specs'</span><span class="p">),</span>
        <span class="n">PrintText</span><span class="p">(</span><span class="s2">"I need a nap, it took me a while to build those specs."</span><span class="p">),</span>
        <span class="n">PrepareVolumes</span><span class="p">(),</span>
    <span class="p">),</span>
    <span class="n">PrintText</span><span class="p">(</span><span class="s2">"Finished volume create"</span><span class="p">,</span> <span class="n">no_slow</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

<span class="c1"># Setup the persistence &amp; resumption layer.</span>
<span class="k">with</span> <span class="n">example_utils</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span> <span class="k">as</span> <span class="n">backend</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">book_id</span><span class="p">,</span> <span class="n">flow_id</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">"+"</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IndexError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">book_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">flow_id</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">book_id</span><span class="p">,</span> <span class="n">flow_id</span><span class="p">]):</span>
        <span class="c1"># If no 'tracking id' (think a fedex or ups tracking id) is provided</span>
        <span class="c1"># then we create one by creating a logbook (where flow details are</span>
        <span class="c1"># stored) and creating a flow detail (where flow and task state is</span>
        <span class="c1"># stored). The combination of these 2 objects unique ids (uuids) allows</span>
        <span class="c1"># the users of taskflow to reassociate the workflows that were</span>
        <span class="c1"># potentially running (and which may have partially completed) back</span>
        <span class="c1"># with taskflow so that those workflows can be resumed (or reverted)</span>
        <span class="c1"># after a process/thread/engine has failed in someway.</span>
        <span class="n">book</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">LogBook</span><span class="p">(</span><span class="s1">'resume-volume-create'</span><span class="p">)</span>
        <span class="n">flow_detail</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FlowDetail</span><span class="p">(</span><span class="s2">"root"</span><span class="p">,</span> <span class="n">uuid</span><span class="o">=</span><span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">())</span>
        <span class="n">book</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">flow_detail</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">backend</span><span class="o">.</span><span class="n">get_connection</span><span class="p">())</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">save_logbook</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"!! Your tracking id is: '</span><span class="si">%s</span><span class="s2">+</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="p">(</span><span class="n">book</span><span class="o">.</span><span class="n">uuid</span><span class="p">,</span>
                                                   <span class="n">flow_detail</span><span class="o">.</span><span class="n">uuid</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"!! Please submit this on later runs for tracking purposes"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">flow_detail</span> <span class="o">=</span> <span class="n">find_flow_detail</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">book_id</span><span class="p">,</span> <span class="n">flow_id</span><span class="p">)</span>

    <span class="c1"># Load and run.</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span>
                          <span class="n">flow_detail</span><span class="o">=</span><span class="n">flow_detail</span><span class="p">,</span>
                          <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'serial'</span><span class="p">)</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

<span class="c1"># How to use.</span>
<span class="c1">#</span>
<span class="c1"># 1. $ python me.py "sqlite:////tmp/cinder.db"</span>
<span class="c1"># 2. ctrl-c before this finishes</span>
<span class="c1"># 3. Find the tracking id (search for 'Your tracking id is')</span>
<span class="c1"># 4. $ python me.py "sqlite:////tmp/cinder.db" "$tracking_id"</span>
<span class="c1"># 5. Profit!</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="running-engines-via-iteration">
<h1>Running engines via iteration<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#running-engines-via-iteration" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/run_by_iter.py">run_by_iter</a></p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">six</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">self_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">self_dir</span><span class="p">)</span>


<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>


<span class="c1"># INTRO: This example shows how to run a set of engines at the same time, each</span>
<span class="c1"># running in different engines using a single thread of control to iterate over</span>
<span class="c1"># each engine (which causes that engine to advanced to its next state during</span>
<span class="c1"># each iteration).</span>


<span class="k">class</span> <span class="nc">EchoTask</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_alphabet_flow</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"alphabet_</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">start_value</span> <span class="o">=</span> <span class="s1">'A'</span>
    <span class="n">end_value</span> <span class="o">=</span> <span class="s1">'Z'</span>
    <span class="n">curr_value</span> <span class="o">=</span> <span class="n">start_value</span>
    <span class="k">while</span> <span class="nb">ord</span><span class="p">(</span><span class="n">curr_value</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">end_value</span><span class="p">):</span>
        <span class="n">next_value</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">curr_value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">curr_value</span> <span class="o">!=</span> <span class="n">end_value</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">EchoTask</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"echoer_</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">curr_value</span><span class="p">,</span>
                           <span class="n">rebind</span><span class="o">=</span><span class="p">{</span><span class="s1">'value'</span><span class="p">:</span> <span class="n">curr_value</span><span class="p">},</span>
                           <span class="n">provides</span><span class="o">=</span><span class="n">next_value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">EchoTask</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"echoer_</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">curr_value</span><span class="p">,</span>
                           <span class="n">rebind</span><span class="o">=</span><span class="p">{</span><span class="s1">'value'</span><span class="p">:</span> <span class="n">curr_value</span><span class="p">}))</span>
        <span class="n">curr_value</span> <span class="o">=</span> <span class="n">next_value</span>
    <span class="k">return</span> <span class="n">f</span>


<span class="c1"># Adjust this number to change how many engines/flows run at once.</span>
<span class="n">flow_count</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">flows</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">flow_count</span><span class="p">):</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">make_alphabet_flow</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">flows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">make_alphabet_flow</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">engine_iters</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flows</span><span class="p">:</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">e</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
    <span class="n">e</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">inject</span><span class="p">({</span><span class="s1">'A'</span><span class="p">:</span> <span class="s1">'A'</span><span class="p">})</span>
    <span class="n">e</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>
    <span class="n">engine_iters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">run_iter</span><span class="p">())</span>
<span class="k">while</span> <span class="n">engine_iters</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">engine_iters</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">it</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="n">engine_iters</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="controlling-retries-using-a-retry-controller">
<h1>Controlling retries using a retry controller<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#controlling-retries-using-a-retry-controller" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/retry_flow.py">retry_flow</a></p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">taskflow.engines</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">retry</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>

<span class="c1"># INTRO: In this example we create a retry controller that receives a phone</span>
<span class="c1"># directory and tries different phone numbers. The next task tries to call Jim</span>
<span class="c1"># using the given number. If it is not a Jim's number, the task raises an</span>
<span class="c1"># exception and retry controller takes the next number from the phone</span>
<span class="c1"># directory and retries the call.</span>
<span class="c1">#</span>
<span class="c1"># This example shows a basic usage of retry controllers in a flow.</span>
<span class="c1"># Retry controllers allows to revert and retry a failed subflow with new</span>
<span class="c1"># parameters.</span>


<span class="k">class</span> <span class="nc">CallJim</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jim_number</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Calling jim </span><span class="si">%s</span><span class="s2">."</span> <span class="o">%</span> <span class="n">jim_number</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jim_number</span> <span class="o">!=</span> <span class="mi">555</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">"Wrong number!"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Hello Jim!"</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">revert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jim_number</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Wrong number, apologizing."</span><span class="p">)</span>


<span class="c1"># Create your flow and associated tasks (the work to be done).</span>
<span class="n">flow</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'retrying-linear'</span><span class="p">,</span>
               <span class="n">retry</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">ParameterizedForEach</span><span class="p">(</span>
                   <span class="n">rebind</span><span class="o">=</span><span class="p">[</span><span class="s1">'phone_directory'</span><span class="p">],</span>
                   <span class="n">provides</span><span class="o">=</span><span class="s1">'jim_number'</span><span class="p">))</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">CallJim</span><span class="p">())</span>

<span class="c1"># Now run that flow using the provided initial data (store below).</span>
<span class="n">taskflow</span><span class="o">.</span><span class="n">engines</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="p">{</span><span class="s1">'phone_directory'</span><span class="p">:</span> <span class="p">[</span><span class="mi">333</span><span class="p">,</span> <span class="mi">444</span><span class="p">,</span> <span class="mi">555</span><span class="p">,</span> <span class="mi">666</span><span class="p">]})</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="distributed-execution-simple">
<h1>Distributed execution (simple)<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#distributed-execution-simple" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/wbe_simple_linear.py">wbe_simple_linear</a></p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.engines.worker_based</span> <span class="kn">import</span> <span class="n">worker</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow.tests</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">taskflow.utils</span> <span class="kn">import</span> <span class="n">threading_utils</span>

<span class="kn">import</span> <span class="nn">example_utils</span>  <span class="c1"># noqa</span>

<span class="c1"># INTRO: This example walks through a miniature workflow which shows how to</span>
<span class="c1"># start up a number of workers (these workers will process task execution and</span>
<span class="c1"># reversion requests using any provided input data) and then use an engine</span>
<span class="c1"># that creates a set of *capable* tasks and flows (the engine can not create</span>
<span class="c1"># tasks that the workers are not able to run, this will end in failure) that</span>
<span class="c1"># those workers will run and then executes that workflow seamlessly using the</span>
<span class="c1"># workers to perform the actual execution.</span>
<span class="c1">#</span>
<span class="c1"># NOTE(harlowja): this example simulates the expected larger number of workers</span>
<span class="c1"># by using a set of threads (which in this example simulate the remote workers</span>
<span class="c1"># that would typically be running on other external machines).</span>

<span class="c1"># A filesystem can also be used as the queue transport (useful as simple</span>
<span class="c1"># transport type that does not involve setting up a larger mq system). If this</span>
<span class="c1"># is false then the memory transport is used instead, both work in standalone</span>
<span class="c1"># setups.</span>
<span class="n">USE_FILESYSTEM</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">BASE_SHARED_CONF</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'exchange'</span><span class="p">:</span> <span class="s1">'taskflow'</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Until https://github.com/celery/kombu/issues/398 is resolved it is not</span>
<span class="c1"># recommended to run many worker threads in this example due to the types</span>
<span class="c1"># of errors mentioned in that issue.</span>
<span class="n">MEMORY_WORKERS</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">FILE_WORKERS</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">WORKER_CONF</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># These are the tasks the worker can execute, they *must* be importable,</span>
    <span class="c1"># typically this list is used to restrict what workers may execute to</span>
    <span class="c1"># a smaller set of *allowed* tasks that are known to be safe (one would</span>
    <span class="c1"># not want to allow all python code to be executed).</span>
    <span class="s1">'tasks'</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">'taskflow.tests.utils:TaskOneArgOneReturn'</span><span class="p">,</span>
        <span class="s1">'taskflow.tests.utils:TaskMultiArgOneReturn'</span>
    <span class="p">],</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">engine_options</span><span class="p">):</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'simple-linear'</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">TaskOneArgOneReturn</span><span class="p">(</span><span class="n">provides</span><span class="o">=</span><span class="s1">'result1'</span><span class="p">),</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">TaskMultiArgOneReturn</span><span class="p">(</span><span class="n">provides</span><span class="o">=</span><span class="s1">'result2'</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">eng</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span>
                       <span class="n">store</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">111</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">222</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="mi">333</span><span class="p">),</span>
                       <span class="n">engine</span><span class="o">=</span><span class="s1">'worker-based'</span><span class="p">,</span> <span class="o">**</span><span class="n">engine_options</span><span class="p">)</span>
    <span class="n">eng</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">eng</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">fetch_all</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

    <span class="c1"># Setup our transport configuration and merge it into the worker and</span>
    <span class="c1"># engine configuration so that both of those use it correctly.</span>
    <span class="n">shared_conf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">BASE_SHARED_CONF</span><span class="p">)</span>

    <span class="n">tmp_path</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">USE_FILESYSTEM</span><span class="p">:</span>
        <span class="n">worker_count</span> <span class="o">=</span> <span class="n">FILE_WORKERS</span>
        <span class="n">tmp_path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">'wbe-example-'</span><span class="p">)</span>
        <span class="n">shared_conf</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">'transport'</span><span class="p">:</span> <span class="s1">'filesystem'</span><span class="p">,</span>
            <span class="s1">'transport_options'</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">'data_folder_in'</span><span class="p">:</span> <span class="n">tmp_path</span><span class="p">,</span>
                <span class="s1">'data_folder_out'</span><span class="p">:</span> <span class="n">tmp_path</span><span class="p">,</span>
                <span class="s1">'polling_interval'</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">worker_count</span> <span class="o">=</span> <span class="n">MEMORY_WORKERS</span>
        <span class="n">shared_conf</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">'transport'</span><span class="p">:</span> <span class="s1">'memory'</span><span class="p">,</span>
            <span class="s1">'transport_options'</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">'polling_interval'</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">})</span>
    <span class="n">worker_conf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">WORKER_CONF</span><span class="p">)</span>
    <span class="n">worker_conf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">shared_conf</span><span class="p">)</span>
    <span class="n">engine_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">shared_conf</span><span class="p">)</span>
    <span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">worker_topics</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Create a set of workers to simulate actual remote workers.</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Running </span><span class="si">%s</span><span class="s1"> workers.'</span> <span class="o">%</span> <span class="p">(</span><span class="n">worker_count</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">worker_count</span><span class="p">):</span>
            <span class="n">worker_conf</span><span class="p">[</span><span class="s1">'topic'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'worker-</span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">worker_topics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">worker_conf</span><span class="p">[</span><span class="s1">'topic'</span><span class="p">])</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">Worker</span><span class="p">(</span><span class="o">**</span><span class="n">worker_conf</span><span class="p">)</span>
            <span class="n">runner</span> <span class="o">=</span> <span class="n">threading_utils</span><span class="o">.</span><span class="n">daemon_thread</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
            <span class="n">runner</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">w</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">workers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">runner</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">stop</span><span class="p">))</span>

        <span class="c1"># Now use those workers to do something.</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Executing some work.'</span><span class="p">)</span>
        <span class="n">engine_options</span><span class="p">[</span><span class="s1">'topics'</span><span class="p">]</span> <span class="o">=</span> <span class="n">worker_topics</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">engine_options</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Execution finished.'</span><span class="p">)</span>
        <span class="c1"># This is done so that the test examples can work correctly</span>
        <span class="c1"># even when the keys change order (which will happen in various</span>
        <span class="c1"># python versions).</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Result = </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># And cleanup.</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Stopping workers.'</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">workers</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">stopper</span> <span class="o">=</span> <span class="n">workers</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">stopper</span><span class="p">()</span>
            <span class="n">r</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">tmp_path</span><span class="p">:</span>
            <span class="n">example_utils</span><span class="o">.</span><span class="n">rm_path</span><span class="p">(</span><span class="n">tmp_path</span><span class="p">)</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="distributed-notification-simple">
<h1>Distributed notification (simple)<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#distributed-notification-simple" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/wbe_event_sender.py">wbe_event_sender</a></p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">range</span> <span class="k">as</span> <span class="n">compat_range</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.engines.worker_based</span> <span class="kn">import</span> <span class="n">worker</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>
<span class="kn">from</span> <span class="nn">taskflow.types</span> <span class="kn">import</span> <span class="n">notifier</span>
<span class="kn">from</span> <span class="nn">taskflow.utils</span> <span class="kn">import</span> <span class="n">threading_utils</span>

<span class="n">ANY</span> <span class="o">=</span> <span class="n">notifier</span><span class="o">.</span><span class="n">Notifier</span><span class="o">.</span><span class="n">ANY</span>

<span class="c1"># INTRO: These examples show how to use a remote worker's event notification</span>
<span class="c1"># attribute to proxy back task event notifications to the controlling process.</span>
<span class="c1">#</span>
<span class="c1"># In this case a simple set of events is triggered by a worker running a</span>
<span class="c1"># task (simulated to be remote by using a kombu memory transport and threads).</span>
<span class="c1"># Those events that the 'remote worker' produces will then be proxied back to</span>
<span class="c1"># the task that the engine is running 'remotely', and then they will be emitted</span>
<span class="c1"># back to the original callbacks that exist in the originating engine</span>
<span class="c1"># process/thread. This creates a one-way *notification* channel that can</span>
<span class="c1"># transparently be used in-process, outside-of-process using remote workers and</span>
<span class="c1"># so-on that allows tasks to signal to its controlling process some sort of</span>
<span class="c1"># action that has occurred that the task may need to tell others about (for</span>
<span class="c1"># example to trigger some type of response when the task reaches 50% done...).</span>


<span class="k">def</span> <span class="nf">event_receiver</span><span class="p">(</span><span class="n">event_type</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
    <span class="sd">"""This is the callback that (in this example) doesn't do much..."""</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Recieved event '</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">event_type</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Details = </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">details</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">EventReporter</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="sd">"""This is the task that will be running 'remotely' (not really remote)."""</span>

    <span class="n">EVENTS</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span><span class="p">)</span>
    <span class="n">EVENT_DELAY</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EVENTS</span><span class="p">):</span>
            <span class="n">details</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">'leftover'</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">EVENTS</span><span class="p">[</span><span class="n">i</span><span class="p">:],</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">details</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">EVENT_DELAY</span><span class="p">)</span>


<span class="n">BASE_SHARED_CONF</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'exchange'</span><span class="p">:</span> <span class="s1">'taskflow'</span><span class="p">,</span>
    <span class="s1">'transport'</span><span class="p">:</span> <span class="s1">'memory'</span><span class="p">,</span>
    <span class="s1">'transport_options'</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">'polling_interval'</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="c1"># Until https://github.com/celery/kombu/issues/398 is resolved it is not</span>
<span class="c1"># recommended to run many worker threads in this example due to the types</span>
<span class="c1"># of errors mentioned in that issue.</span>
<span class="n">MEMORY_WORKERS</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">WORKER_CONF</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'tasks'</span><span class="p">:</span> <span class="p">[</span>
        <span class="c1"># Used to locate which tasks we can run (we don't want to allow</span>
        <span class="c1"># arbitrary code/tasks to be ran by any worker since that would</span>
        <span class="c1"># open up a variety of vulnerabilities).</span>
        <span class="s1">'</span><span class="si">%s</span><span class="s1">:EventReporter'</span> <span class="o">%</span> <span class="p">(</span><span class="vm">__name__</span><span class="p">),</span>
    <span class="p">],</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">engine_options</span><span class="p">):</span>
    <span class="n">reporter</span> <span class="o">=</span> <span class="n">EventReporter</span><span class="p">()</span>
    <span class="n">reporter</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ANY</span><span class="p">,</span> <span class="n">event_receiver</span><span class="p">)</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s1">'event-reporter'</span><span class="p">)</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">reporter</span><span class="p">)</span>
    <span class="n">eng</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s1">'worker-based'</span><span class="p">,</span> <span class="o">**</span><span class="n">engine_options</span><span class="p">)</span>
    <span class="n">eng</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

    <span class="c1"># Setup our transport configuration and merge it into the worker and</span>
    <span class="c1"># engine configuration so that both of those objects use it correctly.</span>
    <span class="n">worker_conf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">WORKER_CONF</span><span class="p">)</span>
    <span class="n">worker_conf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">BASE_SHARED_CONF</span><span class="p">)</span>
    <span class="n">engine_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">BASE_SHARED_CONF</span><span class="p">)</span>
    <span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># These topics will be used to request worker information on; those</span>
    <span class="c1"># workers will respond with their capabilities which the executing engine</span>
    <span class="c1"># will use to match pending tasks to a matched worker, this will cause</span>
    <span class="c1"># the task to be sent for execution, and the engine will wait until it</span>
    <span class="c1"># is finished (a response is received) and then the engine will either</span>
    <span class="c1"># continue with other tasks, do some retry/failure resolution logic or</span>
    <span class="c1"># stop (and potentially re-raise the remote workers failure)...</span>
    <span class="n">worker_topics</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Create a set of worker threads to simulate actual remote workers...</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Running </span><span class="si">%s</span><span class="s1"> workers.'</span> <span class="o">%</span> <span class="p">(</span><span class="n">MEMORY_WORKERS</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">compat_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">MEMORY_WORKERS</span><span class="p">):</span>
            <span class="c1"># Give each one its own unique topic name so that they can</span>
            <span class="c1"># correctly communicate with the engine (they will all share the</span>
            <span class="c1"># same exchange).</span>
            <span class="n">worker_conf</span><span class="p">[</span><span class="s1">'topic'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'worker-</span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">worker_topics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">worker_conf</span><span class="p">[</span><span class="s1">'topic'</span><span class="p">])</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">Worker</span><span class="p">(</span><span class="o">**</span><span class="n">worker_conf</span><span class="p">)</span>
            <span class="n">runner</span> <span class="o">=</span> <span class="n">threading_utils</span><span class="o">.</span><span class="n">daemon_thread</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
            <span class="n">runner</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">w</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">workers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">runner</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">stop</span><span class="p">))</span>

        <span class="c1"># Now use those workers to do something.</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Executing some work.'</span><span class="p">)</span>
        <span class="n">engine_options</span><span class="p">[</span><span class="s1">'topics'</span><span class="p">]</span> <span class="o">=</span> <span class="n">worker_topics</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">engine_options</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Execution finished.'</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># And cleanup.</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Stopping workers.'</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">workers</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">stopper</span> <span class="o">=</span> <span class="n">workers</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">stopper</span><span class="p">()</span>
            <span class="n">r</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="distributed-mandelbrot-complex">
<h1>Distributed mandelbrot (complex)<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#distributed-mandelbrot-complex" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/wbe_mandelbrot.py">wbe_mandelbrot</a></p>
</div>
<div class="section" id="output">
<h2>Output<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#output" title="Permalink to this headline">¶</a></h2>
<a class="reference internal image-reference" href="./Hello world — taskflow 2.9.1.dev11 documentation_files/mandelbrot.png"><img alt="Generated mandelbrot fractal" class="align-right" src="./Hello world — taskflow 2.9.1.dev11 documentation_files/mandelbrot.png" style="height: 128px;"></a>
</div>
<div class="section" id="code">
<h2>Code<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">range</span> <span class="k">as</span> <span class="n">compat_range</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.engines.worker_based</span> <span class="kn">import</span> <span class="n">worker</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">unordered_flow</span> <span class="k">as</span> <span class="n">uf</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>
<span class="kn">from</span> <span class="nn">taskflow.utils</span> <span class="kn">import</span> <span class="n">threading_utils</span>

<span class="c1"># INTRO: This example walks through a workflow that will in parallel compute</span>
<span class="c1"># a mandelbrot result set (using X 'remote' workers) and then combine their</span>
<span class="c1"># results together to form a final mandelbrot fractal image. It shows a usage</span>
<span class="c1"># of taskflow to perform a well-known embarrassingly parallel problem that has</span>
<span class="c1"># the added benefit of also being an elegant visualization.</span>
<span class="c1">#</span>
<span class="c1"># NOTE(harlowja): this example simulates the expected larger number of workers</span>
<span class="c1"># by using a set of threads (which in this example simulate the remote workers</span>
<span class="c1"># that would typically be running on other external machines).</span>
<span class="c1">#</span>
<span class="c1"># NOTE(harlowja): to have it produce an image run (after installing pillow):</span>
<span class="c1">#</span>
<span class="c1"># $ python taskflow/examples/wbe_mandelbrot.py output.png</span>

<span class="n">BASE_SHARED_CONF</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'exchange'</span><span class="p">:</span> <span class="s1">'taskflow'</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">WORKERS</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">WORKER_CONF</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># These are the tasks the worker can execute, they *must* be importable,</span>
    <span class="c1"># typically this list is used to restrict what workers may execute to</span>
    <span class="c1"># a smaller set of *allowed* tasks that are known to be safe (one would</span>
    <span class="c1"># not want to allow all python code to be executed).</span>
    <span class="s1">'tasks'</span><span class="p">:</span> <span class="p">[</span>
        <span class="s1">'</span><span class="si">%s</span><span class="s1">:MandelCalculator'</span> <span class="o">%</span> <span class="p">(</span><span class="vm">__name__</span><span class="p">),</span>
    <span class="p">],</span>
<span class="p">}</span>
<span class="n">ENGINE_CONF</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'engine'</span><span class="p">:</span> <span class="s1">'worker-based'</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># Mandelbrot &amp; image settings...</span>
<span class="n">IMAGE_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
<span class="n">CHUNK_COUNT</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">MAX_ITERATIONS</span> <span class="o">=</span> <span class="mi">25</span>


<span class="k">class</span> <span class="nc">MandelCalculator</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image_config</span><span class="p">,</span> <span class="n">mandelbrot_config</span><span class="p">,</span> <span class="n">chunk</span><span class="p">):</span>
        <span class="sd">"""Returns the number of iterations before the computation "escapes".</span>

<span class="sd">        Given the real and imaginary parts of a complex number, determine if it</span>
<span class="sd">        is a candidate for membership in the mandelbrot set given a fixed</span>
<span class="sd">        number of iterations.</span>
<span class="sd">        """</span>

        <span class="c1"># Parts borrowed from (credit to mark harris and benoît mandelbrot).</span>
        <span class="c1">#</span>
        <span class="c1"># http://nbviewer.ipython.org/gist/harrism/f5707335f40af9463c43</span>
        <span class="k">def</span> <span class="nf">mandelbrot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">max_iters</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="nb">complex</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="mf">0.0j</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">compat_range</span><span class="p">(</span><span class="n">max_iters</span><span class="p">):</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">z</span> <span class="o">+</span> <span class="n">c</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">real</span> <span class="o">*</span> <span class="n">z</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="n">z</span><span class="o">.</span><span class="n">imag</span> <span class="o">*</span> <span class="n">z</span><span class="o">.</span><span class="n">imag</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">i</span>
            <span class="k">return</span> <span class="n">max_iters</span>

        <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">max_iters</span> <span class="o">=</span> <span class="n">mandelbrot_config</span>
        <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">image_config</span><span class="p">[</span><span class="s1">'size'</span><span class="p">]</span>
        <span class="n">pixel_size_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">width</span>
        <span class="n">pixel_size_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">height</span>
        <span class="n">block</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">compat_range</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">row</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">imag</span> <span class="o">=</span> <span class="n">min_y</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">pixel_size_y</span>
            <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">compat_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
                <span class="n">real</span> <span class="o">=</span> <span class="n">min_x</span> <span class="o">+</span> <span class="n">x</span> <span class="o">*</span> <span class="n">pixel_size_x</span>
                <span class="n">row</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mandelbrot</span><span class="p">(</span><span class="n">real</span><span class="p">,</span> <span class="n">imag</span><span class="p">,</span> <span class="n">max_iters</span><span class="p">))</span>
            <span class="n">block</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">block</span>


<span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="n">engine_conf</span><span class="p">):</span>
    <span class="c1"># Subdivide the work into X pieces, then request each worker to calculate</span>
    <span class="c1"># one of those chunks and then later we will write these chunks out to</span>
    <span class="c1"># an image bitmap file.</span>

    <span class="c1"># And unordered flow is used here since the mandelbrot calculation is an</span>
    <span class="c1"># example of an embarrassingly parallel computation that we can scatter</span>
    <span class="c1"># across as many workers as possible.</span>
    <span class="n">flow</span> <span class="o">=</span> <span class="n">uf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"mandelbrot"</span><span class="p">)</span>

    <span class="c1"># These symbols will be automatically given to tasks as input to their</span>
    <span class="c1"># execute method, in this case these are constants used in the mandelbrot</span>
    <span class="c1"># calculation.</span>
    <span class="n">store</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'mandelbrot_config'</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">MAX_ITERATIONS</span><span class="p">],</span>
        <span class="s1">'image_config'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'size'</span><span class="p">:</span> <span class="n">IMAGE_SIZE</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1"># We need the task names to be in the right order so that we can extract</span>
    <span class="c1"># the final results in the right order (we don't care about the order when</span>
    <span class="c1"># executing).</span>
    <span class="n">task_names</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Compose our workflow.</span>
    <span class="n">height</span><span class="p">,</span> <span class="n">_width</span> <span class="o">=</span> <span class="n">IMAGE_SIZE</span>
    <span class="n">chunk_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">height</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">CHUNK_COUNT</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">compat_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CHUNK_COUNT</span><span class="p">):</span>
        <span class="n">chunk_name</span> <span class="o">=</span> <span class="s1">'chunk_</span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="n">i</span>
        <span class="n">task_name</span> <span class="o">=</span> <span class="s2">"calculation_</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">i</span>
        <span class="c1"># Break the calculation up into chunk size pieces.</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">chunk_size</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">chunk_size</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span>
        <span class="n">flow</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
            <span class="n">MandelCalculator</span><span class="p">(</span><span class="n">task_name</span><span class="p">,</span>
                             <span class="c1"># This ensures the storage symbol with name</span>
                             <span class="c1"># 'chunk_name' is sent into the tasks local</span>
                             <span class="c1"># symbol 'chunk'. This is how we give each</span>
                             <span class="c1"># calculator its own correct sequence of rows</span>
                             <span class="c1"># to work on.</span>
                             <span class="n">rebind</span><span class="o">=</span><span class="p">{</span><span class="s1">'chunk'</span><span class="p">:</span> <span class="n">chunk_name</span><span class="p">}))</span>
        <span class="n">store</span><span class="p">[</span><span class="n">chunk_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span>
        <span class="n">task_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task_name</span><span class="p">)</span>

    <span class="c1"># Now execute it.</span>
    <span class="n">eng</span> <span class="o">=</span> <span class="n">engines</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">store</span><span class="o">=</span><span class="n">store</span><span class="p">,</span> <span class="n">engine_conf</span><span class="o">=</span><span class="n">engine_conf</span><span class="p">)</span>
    <span class="n">eng</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Gather all the results and order them for further processing.</span>
    <span class="n">gather</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">task_names</span><span class="p">:</span>
        <span class="n">gather</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">eng</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gather</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">color</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">points</span>


<span class="k">def</span> <span class="nf">write_image</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">output_filename</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Gathered </span><span class="si">%s</span><span class="s2"> results that represents a mandelbrot"</span>
          <span class="s2">" image (using </span><span class="si">%s</span><span class="s2"> chunks that are computed jointly"</span>
          <span class="s2">" by </span><span class="si">%s</span><span class="s2"> workers)."</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">),</span> <span class="n">CHUNK_COUNT</span><span class="p">,</span> <span class="n">WORKERS</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">output_filename</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Pillow (the PIL fork) saves us from writing our own image writer...</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
    <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="c1"># To currently get this (may change in the future),</span>
        <span class="c1"># $ pip install Pillow</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">"Pillow is required to write image files: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

    <span class="c1"># Limit to 255, find the max and normalize to that...</span>
    <span class="n">color_max</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_point</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="n">color_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="n">color_max</span><span class="p">)</span>

    <span class="c1"># Use gray scale since we don't really have other colors.</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'L'</span><span class="p">,</span> <span class="n">IMAGE_SIZE</span><span class="p">,</span> <span class="s2">"black"</span><span class="p">)</span>
    <span class="n">pixels</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">color</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">color_max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="nb">float</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">/</span> <span class="n">color_max</span><span class="p">)</span> <span class="o">*</span> <span class="mf">255.0</span><span class="p">)</span>
        <span class="n">pixels</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span>
    <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">output_filename</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">create_fractal</span><span class="p">():</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

    <span class="c1"># Setup our transport configuration and merge it into the worker and</span>
    <span class="c1"># engine configuration so that both of those use it correctly.</span>
    <span class="n">shared_conf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">BASE_SHARED_CONF</span><span class="p">)</span>
    <span class="n">shared_conf</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">'transport'</span><span class="p">:</span> <span class="s1">'memory'</span><span class="p">,</span>
        <span class="s1">'transport_options'</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">'polling_interval'</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">})</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_filename</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">worker_conf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">WORKER_CONF</span><span class="p">)</span>
    <span class="n">worker_conf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">shared_conf</span><span class="p">)</span>
    <span class="n">engine_conf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ENGINE_CONF</span><span class="p">)</span>
    <span class="n">engine_conf</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">shared_conf</span><span class="p">)</span>
    <span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">worker_topics</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">print</span><span class="p">(</span><span class="s1">'Calculating your mandelbrot fractal of size </span><span class="si">%s</span><span class="s1">x</span><span class="si">%s</span><span class="s1">.'</span> <span class="o">%</span> <span class="n">IMAGE_SIZE</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Create a set of workers to simulate actual remote workers.</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Running </span><span class="si">%s</span><span class="s1"> workers.'</span> <span class="o">%</span> <span class="p">(</span><span class="n">WORKERS</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">compat_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">WORKERS</span><span class="p">):</span>
            <span class="n">worker_conf</span><span class="p">[</span><span class="s1">'topic'</span><span class="p">]</span> <span class="o">=</span> <span class="s1">'calculator_</span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">worker_topics</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">worker_conf</span><span class="p">[</span><span class="s1">'topic'</span><span class="p">])</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">Worker</span><span class="p">(</span><span class="o">**</span><span class="n">worker_conf</span><span class="p">)</span>
            <span class="n">runner</span> <span class="o">=</span> <span class="n">threading_utils</span><span class="o">.</span><span class="n">daemon_thread</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">run</span><span class="p">)</span>
            <span class="n">runner</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">w</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
            <span class="n">workers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">runner</span><span class="p">,</span> <span class="n">w</span><span class="o">.</span><span class="n">stop</span><span class="p">))</span>

        <span class="c1"># Now use those workers to do something.</span>
        <span class="n">engine_conf</span><span class="p">[</span><span class="s1">'topics'</span><span class="p">]</span> <span class="o">=</span> <span class="n">worker_topics</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">calculate</span><span class="p">(</span><span class="n">engine_conf</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Execution finished.'</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># And cleanup.</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">'Stopping workers.'</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">workers</span><span class="p">:</span>
            <span class="n">r</span><span class="p">,</span> <span class="n">stopper</span> <span class="o">=</span> <span class="n">workers</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">stopper</span><span class="p">()</span>
            <span class="n">r</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Writing image..."</span><span class="p">)</span>
    <span class="n">write_image</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">output_filename</span><span class="o">=</span><span class="n">output_filename</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">create_fractal</span><span class="p">()</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
</div>
<div class="section" id="jobboard-producer-consumer-simple">
<h1>Jobboard producer/consumer (simple)<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#jobboard-producer-consumer-simple" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/jobboard_produce_consume_colors.py">jobboard_produce_consume_colors</a></p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">range</span> <span class="k">as</span> <span class="n">compat_range</span>
<span class="kn">from</span> <span class="nn">zake</span> <span class="kn">import</span> <span class="n">fake_client</span>

<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">exceptions</span> <span class="k">as</span> <span class="n">excp</span>
<span class="kn">from</span> <span class="nn">taskflow.jobs</span> <span class="kn">import</span> <span class="n">backends</span>
<span class="kn">from</span> <span class="nn">taskflow.utils</span> <span class="kn">import</span> <span class="n">threading_utils</span>

<span class="c1"># In this example we show how a jobboard can be used to post work for other</span>
<span class="c1"># entities to work on. This example creates a set of jobs using one producer</span>
<span class="c1"># thread (typically this would be split across many machines) and then having</span>
<span class="c1"># other worker threads with their own jobboards select work using a given</span>
<span class="c1"># filters [red/blue] and then perform that work (and consuming or abandoning</span>
<span class="c1"># the job after it has been completed or failed).</span>

<span class="c1"># Things to note:</span>
<span class="c1"># - No persistence layer is used (or logbook), just the job details are used</span>
<span class="c1">#   to determine if a job should be selected by a worker or not.</span>
<span class="c1"># - This example runs in a single process (this is expected to be atypical</span>
<span class="c1">#   but this example shows that it can be done if needed, for testing...)</span>
<span class="c1"># - The iterjobs(), claim(), consume()/abandon() worker workflow.</span>
<span class="c1"># - The post() producer workflow.</span>

<span class="n">SHARED_CONF</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'path'</span><span class="p">:</span> <span class="s2">"/taskflow/jobs"</span><span class="p">,</span>
    <span class="s1">'board'</span><span class="p">:</span> <span class="s1">'zookeeper'</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># How many workers and producers of work will be created (as threads).</span>
<span class="n">PRODUCERS</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">WORKERS</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># How many units of work each producer will create.</span>
<span class="n">PRODUCER_UNITS</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># How many units of work are expected to be produced (used so workers can</span>
<span class="c1"># know when to stop running and shutdown, typically this would not be a</span>
<span class="c1"># a value but we have to limit this example's execution time to be less than</span>
<span class="c1"># infinity).</span>
<span class="n">EXPECTED_UNITS</span> <span class="o">=</span> <span class="n">PRODUCER_UNITS</span> <span class="o">*</span> <span class="n">PRODUCERS</span>

<span class="c1"># Delay between producing/consuming more work.</span>
<span class="n">WORKER_DELAY</span><span class="p">,</span> <span class="n">PRODUCER_DELAY</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># To ensure threads don't trample other threads output.</span>
<span class="n">STDOUT_LOCK</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">dispatch_work</span><span class="p">(</span><span class="n">job</span><span class="p">):</span>
    <span class="c1"># This is where the jobs contained work *would* be done</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">safe_print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">""</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">STDOUT_LOCK</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prefix</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="n">consumed</span><span class="p">):</span>
    <span class="c1"># Create a personal board (using the same client so that it works in</span>
    <span class="c1"># the same process) and start looking for jobs on the board that we want</span>
    <span class="c1"># to perform.</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">"W-</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">ident</span><span class="p">)</span>
    <span class="n">safe_print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">"started"</span><span class="p">)</span>
    <span class="n">claimed_jobs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">consumed_jobs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">abandoned_jobs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="n">backends</span><span class="o">.</span><span class="n">backend</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">SHARED_CONF</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span> <span class="k">as</span> <span class="n">board</span><span class="p">:</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">consumed</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EXPECTED_UNITS</span><span class="p">:</span>
            <span class="n">favorite_color</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">'blue'</span><span class="p">,</span> <span class="s1">'red'</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">board</span><span class="o">.</span><span class="n">iterjobs</span><span class="p">(</span><span class="n">ensure_fresh</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">only_unclaimed</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
                <span class="c1"># See if we should even bother with it...</span>
                <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'color'</span><span class="p">)</span> <span class="o">!=</span> <span class="n">favorite_color</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">safe_print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">"'</span><span class="si">%s</span><span class="s2">' [attempting claim]"</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">board</span><span class="o">.</span><span class="n">claim</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                    <span class="n">claimed_jobs</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">safe_print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">"'</span><span class="si">%s</span><span class="s2">' [claimed]"</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="p">))</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">excp</span><span class="o">.</span><span class="n">NotFound</span><span class="p">,</span> <span class="n">excp</span><span class="o">.</span><span class="n">UnclaimableJob</span><span class="p">):</span>
                    <span class="n">safe_print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">"'</span><span class="si">%s</span><span class="s2">' [claim unsuccessful]"</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dispatch_work</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                        <span class="n">board</span><span class="o">.</span><span class="n">consume</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="n">safe_print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">"'</span><span class="si">%s</span><span class="s2">' [consumed]"</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="p">))</span>
                        <span class="n">consumed_jobs</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">consumed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">board</span><span class="o">.</span><span class="n">abandon</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="n">abandoned_jobs</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">safe_print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">"'</span><span class="si">%s</span><span class="s2">' [abandoned]"</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="p">))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">WORKER_DELAY</span><span class="p">)</span>
    <span class="n">safe_print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span>
               <span class="s2">"finished (claimed </span><span class="si">%s</span><span class="s2"> jobs, consumed </span><span class="si">%s</span><span class="s2"> jobs,"</span>
               <span class="s2">" abandoned </span><span class="si">%s</span><span class="s2"> jobs)"</span> <span class="o">%</span> <span class="p">(</span><span class="n">claimed_jobs</span><span class="p">,</span> <span class="n">consumed_jobs</span><span class="p">,</span>
                                        <span class="n">abandoned_jobs</span><span class="p">),</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">"&gt;&gt;&gt;"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">producer</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="n">client</span><span class="p">):</span>
    <span class="c1"># Create a personal board (using the same client so that it works in</span>
    <span class="c1"># the same process) and start posting jobs on the board that we want</span>
    <span class="c1"># some entity to perform.</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s2">"P-</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">ident</span><span class="p">)</span>
    <span class="n">safe_print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">"started"</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">backends</span><span class="o">.</span><span class="n">backend</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">SHARED_CONF</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">)</span> <span class="k">as</span> <span class="n">board</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">compat_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PRODUCER_UNITS</span><span class="p">):</span>
            <span class="n">job_name</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">-</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">details</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">'color'</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s1">'red'</span><span class="p">,</span> <span class="s1">'blue'</span><span class="p">]),</span>
            <span class="p">}</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">board</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">)</span>
            <span class="n">safe_print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">"'</span><span class="si">%s</span><span class="s2">' [posted]"</span> <span class="o">%</span> <span class="p">(</span><span class="n">job</span><span class="p">))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">PRODUCER_DELAY</span><span class="p">)</span>
    <span class="n">safe_print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">"finished"</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">"&gt;&gt;&gt;"</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">six</span><span class="o">.</span><span class="n">PY3</span><span class="p">:</span>
        <span class="c1"># TODO(harlowja): Hack to make eventlet work right, remove when the</span>
        <span class="c1"># following is fixed: https://github.com/eventlet/eventlet/issues/230</span>
        <span class="kn">from</span> <span class="nn">taskflow.utils</span> <span class="kn">import</span> <span class="n">eventlet_utils</span> <span class="k">as</span> <span class="n">_eu</span>  <span class="c1"># noqa</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">eventlet</span> <span class="kn">as</span> <span class="nn">_eventlet</span>  <span class="c1"># noqa</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">fake_client</span><span class="o">.</span><span class="n">FakeClient</span><span class="p">())</span> <span class="k">as</span> <span class="n">c</span><span class="p">:</span>
        <span class="n">created</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">compat_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PRODUCERS</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">threading_utils</span><span class="o">.</span><span class="n">daemon_thread</span><span class="p">(</span><span class="n">producer</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
            <span class="n">created</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">consumed</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">deque</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">compat_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">WORKERS</span><span class="p">):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">threading_utils</span><span class="o">.</span><span class="n">daemon_thread</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">consumed</span><span class="p">)</span>
            <span class="n">created</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
            <span class="n">w</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">while</span> <span class="n">created</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">created</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
        <span class="c1"># At the end there should be nothing leftover, let's verify that.</span>
        <span class="n">board</span> <span class="o">=</span> <span class="n">backends</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">'verifier'</span><span class="p">,</span> <span class="n">SHARED_CONF</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">client</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>
        <span class="n">board</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">board</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">board</span><span class="o">.</span><span class="n">job_count</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">consumed</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EXPECTED_UNITS</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="mi">0</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">())</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="conductor-simulating-a-ci-pipeline">
<h1>Conductor simulating a CI pipeline<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#conductor-simulating-a-ci-pipeline" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/tox_conductor.py">tox_conductor</a></p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">timeutils</span>
<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">uuidutils</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">zake</span> <span class="kn">import</span> <span class="n">fake_client</span>

<span class="kn">from</span> <span class="nn">taskflow.conductors</span> <span class="kn">import</span> <span class="n">backends</span> <span class="k">as</span> <span class="n">conductors</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.jobs</span> <span class="kn">import</span> <span class="n">backends</span> <span class="k">as</span> <span class="n">boards</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span>
<span class="kn">from</span> <span class="nn">taskflow.persistence</span> <span class="kn">import</span> <span class="n">backends</span> <span class="k">as</span> <span class="n">persistence</span>
<span class="kn">from</span> <span class="nn">taskflow.persistence</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>
<span class="kn">from</span> <span class="nn">taskflow.utils</span> <span class="kn">import</span> <span class="n">threading_utils</span>

<span class="c1"># INTRO: This examples shows how a worker/producer can post desired work (jobs)</span>
<span class="c1"># to a jobboard and a conductor can consume that work (jobs) from that jobboard</span>
<span class="c1"># and execute those jobs in a reliable &amp; async manner (for example, if the</span>
<span class="c1"># conductor were to crash then the job will be released back onto the jobboard</span>
<span class="c1"># and another conductor can attempt to finish it, from wherever that job last</span>
<span class="c1"># left off).</span>
<span class="c1">#</span>
<span class="c1"># In this example a in-memory jobboard (and in-memory storage) is created and</span>
<span class="c1"># used that simulates how this would be done at a larger scale (it is an</span>
<span class="c1"># example after all).</span>

<span class="c1"># Restrict how long this example runs for...</span>
<span class="n">RUN_TIME</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">REVIEW_CREATION_DELAY</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">SCAN_DELAY</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">NAME</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>

<span class="c1"># This won't really use zookeeper but will use a local version of it using</span>
<span class="c1"># the zake library that mimics an actual zookeeper cluster using threads and</span>
<span class="c1"># an in-memory data structure.</span>
<span class="n">JOBBOARD_CONF</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'board'</span><span class="p">:</span> <span class="s1">'zookeeper://localhost?path=/taskflow/tox/jobs'</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">class</span> <span class="nc">RunReview</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="c1"># A dummy task that clones the review and runs tox...</span>

    <span class="k">def</span> <span class="nf">_clone_review</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">review</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Cloning review '</span><span class="si">%s</span><span class="s2">' into </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">review</span><span class="p">[</span><span class="s1">'id'</span><span class="p">],</span> <span class="n">temp_dir</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_run_tox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Running tox in </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">temp_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">review</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clone_review</span><span class="p">(</span><span class="n">review</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_tox</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">MakeTempDir</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="c1"># A task that creates and destroys a temporary dir (on failure).</span>
    <span class="c1">#</span>
    <span class="c1"># It provides the location of the temporary dir for other tasks to use</span>
    <span class="c1"># as they see fit.</span>

    <span class="n">default_provides</span> <span class="o">=</span> <span class="s1">'temp_dir'</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">revert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">REVERT_RESULT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temp_dir</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CleanResources</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="c1"># A task that cleans up any workflow resources.</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">temp_dir</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Removing </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">temp_dir</span><span class="p">)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">review_iter</span><span class="p">():</span>
    <span class="sd">"""Makes reviews (never-ending iterator/generator)."""</span>
    <span class="n">review_id_gen</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">review_id</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">review_id_gen</span><span class="p">)</span>
        <span class="n">review</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">'id'</span><span class="p">:</span> <span class="n">review_id</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">yield</span> <span class="n">review</span>


<span class="c1"># The reason this is at the module namespace level is important, since it must</span>
<span class="c1"># be accessible from a conductor dispatching an engine, if it was a lambda</span>
<span class="c1"># function for example, it would not be reimportable and the conductor would</span>
<span class="c1"># be unable to reference it when creating the workflow to run.</span>
<span class="k">def</span> <span class="nf">create_review_workflow</span><span class="p">():</span>
    <span class="sd">"""Factory method used to create a review workflow to run."""</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">linear_flow</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"tester"</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
        <span class="n">MakeTempDir</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"maker"</span><span class="p">),</span>
        <span class="n">RunReview</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"runner"</span><span class="p">),</span>
        <span class="n">CleanResources</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">"cleaner"</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">f</span>


<span class="k">def</span> <span class="nf">generate_reviewer</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">saver</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">NAME</span><span class="p">):</span>
    <span class="sd">"""Creates a review producer thread with the given name prefix."""</span>
    <span class="n">real_name</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">_reviewer"</span> <span class="o">%</span> <span class="n">name</span>
    <span class="n">no_more</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="n">jb</span> <span class="o">=</span> <span class="n">boards</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">real_name</span><span class="p">,</span> <span class="n">JOBBOARD_CONF</span><span class="p">,</span>
                      <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">persistence</span><span class="o">=</span><span class="n">saver</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_save_book</span><span class="p">(</span><span class="n">saver</span><span class="p">,</span> <span class="n">review_id</span><span class="p">):</span>
        <span class="c1"># Record what we want to happen (sometime in the future).</span>
        <span class="n">book</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">LogBook</span><span class="p">(</span><span class="s2">"book_</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">review_id</span><span class="p">)</span>
        <span class="n">detail</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FlowDetail</span><span class="p">(</span><span class="s2">"flow_</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">review_id</span><span class="p">,</span>
                                   <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">())</span>
        <span class="n">book</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">detail</span><span class="p">)</span>
        <span class="c1"># Associate the factory method we want to be called (in the future)</span>
        <span class="c1"># with the book, so that the conductor will be able to call into</span>
        <span class="c1"># that factory to retrieve the workflow objects that represent the</span>
        <span class="c1"># work.</span>
        <span class="c1">#</span>
        <span class="c1"># These args and kwargs *can* be used to save any specific parameters</span>
        <span class="c1"># into the factory when it is being called to create the workflow</span>
        <span class="c1"># objects (typically used to tell a factory how to create a unique</span>
        <span class="c1"># workflow that represents this review).</span>
        <span class="n">factory_args</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">factory_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">engines</span><span class="o">.</span><span class="n">save_factory_details</span><span class="p">(</span><span class="n">detail</span><span class="p">,</span> <span class="n">create_review_workflow</span><span class="p">,</span>
                                     <span class="n">factory_args</span><span class="p">,</span> <span class="n">factory_kwargs</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">saver</span><span class="o">.</span><span class="n">get_connection</span><span class="p">())</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">save_logbook</span><span class="p">(</span><span class="n">book</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">book</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
        <span class="sd">"""Periodically publishes 'fake' reviews to analyze."""</span>
        <span class="n">jb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="n">review_generator</span> <span class="o">=</span> <span class="n">review_iter</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">jb</span><span class="p">):</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">no_more</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                <span class="n">review</span> <span class="o">=</span> <span class="n">six</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="n">review_generator</span><span class="p">)</span>
                <span class="n">details</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s1">'store'</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">'review'</span><span class="p">:</span> <span class="n">review</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">}</span>
                <span class="n">job_name</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">_</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">real_name</span><span class="p">,</span> <span class="n">review</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"Posting review '</span><span class="si">%s</span><span class="s2">'"</span> <span class="o">%</span> <span class="n">review</span><span class="p">[</span><span class="s1">'id'</span><span class="p">])</span>
                <span class="n">jb</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span>
                        <span class="n">book</span><span class="o">=</span><span class="n">make_save_book</span><span class="p">(</span><span class="n">saver</span><span class="p">,</span> <span class="n">review</span><span class="p">[</span><span class="s1">'id'</span><span class="p">]),</span>
                        <span class="n">details</span><span class="o">=</span><span class="n">details</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">REVIEW_CREATION_DELAY</span><span class="p">)</span>

    <span class="c1"># Return the unstarted thread, and a callback that can be used</span>
    <span class="c1"># shutdown that thread (to avoid running forever).</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">threading_utils</span><span class="o">.</span><span class="n">daemon_thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run</span><span class="p">),</span> <span class="n">no_more</span><span class="o">.</span><span class="n">set</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">generate_conductor</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">saver</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">NAME</span><span class="p">):</span>
    <span class="sd">"""Creates a conductor thread with the given name prefix."""</span>
    <span class="n">real_name</span> <span class="o">=</span> <span class="s2">"</span><span class="si">%s</span><span class="s2">_conductor"</span> <span class="o">%</span> <span class="n">name</span>
    <span class="n">jb</span> <span class="o">=</span> <span class="n">boards</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">JOBBOARD_CONF</span><span class="p">,</span>
                      <span class="n">client</span><span class="o">=</span><span class="n">client</span><span class="p">,</span> <span class="n">persistence</span><span class="o">=</span><span class="n">saver</span><span class="p">)</span>
    <span class="n">conductor</span> <span class="o">=</span> <span class="n">conductors</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s2">"blocking"</span><span class="p">,</span> <span class="n">real_name</span><span class="p">,</span> <span class="n">jb</span><span class="p">,</span>
                                 <span class="n">engine</span><span class="o">=</span><span class="s1">'parallel'</span><span class="p">,</span> <span class="n">wait_timeout</span><span class="o">=</span><span class="n">SCAN_DELAY</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
        <span class="n">jb</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">jb</span><span class="p">):</span>
            <span class="n">conductor</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="c1"># Return the unstarted thread, and a callback that can be used</span>
    <span class="c1"># shutdown that thread (to avoid running forever).</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">threading_utils</span><span class="o">.</span><span class="n">daemon_thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run</span><span class="p">),</span> <span class="n">conductor</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Need to share the same backend, so that data can be shared...</span>
    <span class="n">persistence_conf</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'connection'</span><span class="p">:</span> <span class="s1">'memory'</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">saver</span> <span class="o">=</span> <span class="n">persistence</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">persistence_conf</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">saver</span><span class="o">.</span><span class="n">get_connection</span><span class="p">())</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
        <span class="c1"># This ensures that the needed backend setup/data directories/schema</span>
        <span class="c1"># upgrades and so on... exist before they are attempted to be used...</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">upgrade</span><span class="p">()</span>
    <span class="n">fc1</span> <span class="o">=</span> <span class="n">fake_client</span><span class="o">.</span><span class="n">FakeClient</span><span class="p">()</span>
    <span class="c1"># Done like this to share the same client storage location so the correct</span>
    <span class="c1"># zookeeper features work across clients...</span>
    <span class="n">fc2</span> <span class="o">=</span> <span class="n">fake_client</span><span class="o">.</span><span class="n">FakeClient</span><span class="p">(</span><span class="n">storage</span><span class="o">=</span><span class="n">fc1</span><span class="o">.</span><span class="n">storage</span><span class="p">)</span>
    <span class="n">entities</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">generate_reviewer</span><span class="p">(</span><span class="n">fc1</span><span class="p">,</span> <span class="n">saver</span><span class="p">),</span>
        <span class="n">generate_conductor</span><span class="p">(</span><span class="n">fc2</span><span class="p">,</span> <span class="n">saver</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">stopper</span> <span class="ow">in</span> <span class="n">entities</span><span class="p">:</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">watch</span> <span class="o">=</span> <span class="n">timeutils</span><span class="o">.</span><span class="n">StopWatch</span><span class="p">(</span><span class="n">duration</span><span class="o">=</span><span class="n">RUN_TIME</span><span class="p">)</span>
        <span class="n">watch</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">watch</span><span class="o">.</span><span class="n">expired</span><span class="p">():</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">stopper</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">entities</span><span class="p">):</span>
            <span class="n">stopper</span><span class="p">()</span>
            <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</td></tr></tbody></table></div>
</div>
<div class="section" id="conductor-running-99-bottles-of-beer-song-requests">
<h1>Conductor running 99 bottles of beer song requests<a class="headerlink" href="https://docs.openstack.org/developer/taskflow/examples.html#conductor-running-99-bottles-of-beer-song-requests" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Full source located at <a class="reference external" href="https://git.openstack.org/cgit/openstack/taskflow/tree/taskflow/examples/99_bottles.py">99_bottles</a></p>
</div>
<div class="highlight-python"><table class="highlighttable"><tbody><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227</pre></div></td><td class="code"><div class="highlight"><pre><span></span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">from</span> <span class="nn">kazoo</span> <span class="kn">import</span> <span class="n">client</span>

<span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">,</span>
                                       <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">top_dir</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">taskflow.conductors</span> <span class="kn">import</span> <span class="n">backends</span> <span class="k">as</span> <span class="n">conductor_backends</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">engines</span>
<span class="kn">from</span> <span class="nn">taskflow.jobs</span> <span class="kn">import</span> <span class="n">backends</span> <span class="k">as</span> <span class="n">job_backends</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">logging</span> <span class="k">as</span> <span class="n">taskflow_logging</span>
<span class="kn">from</span> <span class="nn">taskflow.patterns</span> <span class="kn">import</span> <span class="n">linear_flow</span> <span class="k">as</span> <span class="n">lf</span>
<span class="kn">from</span> <span class="nn">taskflow.persistence</span> <span class="kn">import</span> <span class="n">backends</span> <span class="k">as</span> <span class="n">persistence_backends</span>
<span class="kn">from</span> <span class="nn">taskflow.persistence</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">taskflow</span> <span class="kn">import</span> <span class="n">task</span>
<span class="kn">from</span> <span class="nn">taskflow.types</span> <span class="kn">import</span> <span class="n">timing</span>

<span class="kn">from</span> <span class="nn">oslo_utils</span> <span class="kn">import</span> <span class="n">uuidutils</span>

<span class="c1"># Instructions!</span>
<span class="c1">#</span>
<span class="c1"># 1. Install zookeeper (or change host listed below)</span>
<span class="c1"># 2. Download this example, place in file '99_bottles.py'</span>
<span class="c1"># 3. Run `python 99_bottles.py p` to place a song request onto the jobboard</span>
<span class="c1"># 4. Run `python 99_bottles.py c` a few times (in different shells)</span>
<span class="c1"># 5. On demand kill previously listed processes created in (4) and watch</span>
<span class="c1">#    the work resume on another process (and repeat)</span>
<span class="c1"># 6. Keep enough workers alive to eventually finish the song (if desired).</span>

<span class="n">ME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
<span class="n">ZK_HOST</span> <span class="o">=</span> <span class="s2">"localhost:2181"</span>
<span class="n">JB_CONF</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">'hosts'</span><span class="p">:</span> <span class="n">ZK_HOST</span><span class="p">,</span>
    <span class="s1">'board'</span><span class="p">:</span> <span class="s1">'zookeeper'</span><span class="p">,</span>
    <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/taskflow/99-bottles-demo'</span><span class="p">,</span>
<span class="p">}</span>
<span class="n">PERSISTENCE_URI</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">"sqlite:////tmp/bottles.db"</span>
<span class="n">TAKE_DOWN_DELAY</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">PASS_AROUND_DELAY</span> <span class="o">=</span> <span class="mf">3.0</span>
<span class="n">HOW_MANY_BOTTLES</span> <span class="o">=</span> <span class="mi">99</span>


<span class="k">class</span> <span class="nc">TakeABottleDown</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bottles_left</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'Take one down, '</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">TAKE_DOWN_DELAY</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bottles_left</span> <span class="o">-</span> <span class="mi">1</span>


<span class="k">class</span> <span class="nc">PassItAround</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'pass it around, '</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">PASS_AROUND_DELAY</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Conclusion</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">Task</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bottles_left</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">'</span><span class="si">%s</span><span class="s1"> bottles of beer on the wall...</span><span class="se">\n</span><span class="s1">'</span> <span class="o">%</span> <span class="n">bottles_left</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">make_bottles</span><span class="p">(</span><span class="n">count</span><span class="p">):</span>
    <span class="c1"># This is the function that will be called to generate the workflow</span>
    <span class="c1"># and will also be called to regenerate it on resumption so that work</span>
    <span class="c1"># can continue from where it last left off...</span>

    <span class="n">s</span> <span class="o">=</span> <span class="n">lf</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span><span class="s2">"bottle-song"</span><span class="p">)</span>

    <span class="n">take_bottle</span> <span class="o">=</span> <span class="n">TakeABottleDown</span><span class="p">(</span><span class="s2">"take-bottle-</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">count</span><span class="p">,</span>
                                  <span class="n">inject</span><span class="o">=</span><span class="p">{</span><span class="s1">'bottles_left'</span><span class="p">:</span> <span class="n">count</span><span class="p">},</span>
                                  <span class="n">provides</span><span class="o">=</span><span class="s1">'bottles_left'</span><span class="p">)</span>
    <span class="n">pass_it</span> <span class="o">=</span> <span class="n">PassItAround</span><span class="p">(</span><span class="s2">"pass-</span><span class="si">%s</span><span class="s2">-around"</span> <span class="o">%</span> <span class="n">count</span><span class="p">)</span>
    <span class="n">next_bottles</span> <span class="o">=</span> <span class="n">Conclusion</span><span class="p">(</span><span class="s2">"next-bottles-</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">take_bottle</span><span class="p">,</span> <span class="n">pass_it</span><span class="p">,</span> <span class="n">next_bottles</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">bottle</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">count</span><span class="p">))):</span>
        <span class="n">take_bottle</span> <span class="o">=</span> <span class="n">TakeABottleDown</span><span class="p">(</span><span class="s2">"take-bottle-</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">bottle</span><span class="p">,</span>
                                      <span class="n">provides</span><span class="o">=</span><span class="s1">'bottles_left'</span><span class="p">)</span>
        <span class="n">pass_it</span> <span class="o">=</span> <span class="n">PassItAround</span><span class="p">(</span><span class="s2">"pass-</span><span class="si">%s</span><span class="s2">-around"</span> <span class="o">%</span> <span class="n">bottle</span><span class="p">)</span>
        <span class="n">next_bottles</span> <span class="o">=</span> <span class="n">Conclusion</span><span class="p">(</span><span class="s2">"next-bottles-</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="p">(</span><span class="n">bottle</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">take_bottle</span><span class="p">,</span> <span class="n">pass_it</span><span class="p">,</span> <span class="n">next_bottles</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">run_conductor</span><span class="p">(</span><span class="n">only_run_once</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="c1"># This continuously runs consumers until its stopped via ctrl-c or other</span>
    <span class="c1"># kill signal...</span>
    <span class="n">event_watches</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># This will be triggered by the conductor doing various activities</span>
    <span class="c1"># with engines, and is quite nice to be able to see the various timing</span>
    <span class="c1"># segments (which is useful for debugging, or watching, or figuring out</span>
    <span class="c1"># where to optimize).</span>
    <span class="k">def</span> <span class="nf">on_conductor_event</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">details</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Event '</span><span class="si">%s</span><span class="s2">' has been received..."</span> <span class="o">%</span> <span class="n">event</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">"Details = </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">details</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">"_start"</span><span class="p">):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">timing</span><span class="o">.</span><span class="n">StopWatch</span><span class="p">()</span>
            <span class="n">w</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="n">base_event</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s2">"_start"</span><span class="p">)]</span>
            <span class="n">event_watches</span><span class="p">[</span><span class="n">base_event</span><span class="p">]</span> <span class="o">=</span> <span class="n">w</span>
        <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">"_end"</span><span class="p">):</span>
            <span class="n">base_event</span> <span class="o">=</span> <span class="n">event</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s2">"_end"</span><span class="p">)]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">event_watches</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">base_event</span><span class="p">)</span>
                <span class="n">w</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">"It took </span><span class="si">%0.3f</span><span class="s2"> seconds for event '</span><span class="si">%s</span><span class="s2">' to finish"</span>
                      <span class="o">%</span> <span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">elapsed</span><span class="p">(),</span> <span class="n">base_event</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s1">'running_end'</span> <span class="ow">and</span> <span class="n">only_run_once</span><span class="p">:</span>
            <span class="n">cond</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">"Starting conductor with pid: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">ME</span><span class="p">)</span>
    <span class="n">my_name</span> <span class="o">=</span> <span class="s2">"conductor-</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">ME</span>
    <span class="n">persist_backend</span> <span class="o">=</span> <span class="n">persistence_backends</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">PERSISTENCE_URI</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">persist_backend</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">persist_backend</span><span class="o">.</span><span class="n">get_connection</span><span class="p">())</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">upgrade</span><span class="p">()</span>
        <span class="n">job_backend</span> <span class="o">=</span> <span class="n">job_backends</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">my_name</span><span class="p">,</span> <span class="n">JB_CONF</span><span class="p">,</span>
                                         <span class="n">persistence</span><span class="o">=</span><span class="n">persist_backend</span><span class="p">)</span>
        <span class="n">job_backend</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">job_backend</span><span class="p">):</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="n">conductor_backends</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">'blocking'</span><span class="p">,</span> <span class="n">my_name</span><span class="p">,</span> <span class="n">job_backend</span><span class="p">,</span>
                                            <span class="n">persistence</span><span class="o">=</span><span class="n">persist_backend</span><span class="p">)</span>
            <span class="n">on_conductor_event</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">on_conductor_event</span><span class="p">,</span> <span class="n">cond</span><span class="p">)</span>
            <span class="n">cond</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">cond</span><span class="o">.</span><span class="n">notifier</span><span class="o">.</span><span class="n">ANY</span><span class="p">,</span> <span class="n">on_conductor_event</span><span class="p">)</span>
            <span class="c1"># Run forever, and kill -9 or ctrl-c me...</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cond</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">cond</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="n">cond</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">run_poster</span><span class="p">():</span>
    <span class="c1"># This just posts a single job and then ends...</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">"Starting poster with pid: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">ME</span><span class="p">)</span>
    <span class="n">my_name</span> <span class="o">=</span> <span class="s2">"poster-</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">ME</span>
    <span class="n">persist_backend</span> <span class="o">=</span> <span class="n">persistence_backends</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">PERSISTENCE_URI</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">persist_backend</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">persist_backend</span><span class="o">.</span><span class="n">get_connection</span><span class="p">())</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">upgrade</span><span class="p">()</span>
        <span class="n">job_backend</span> <span class="o">=</span> <span class="n">job_backends</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">my_name</span><span class="p">,</span> <span class="n">JB_CONF</span><span class="p">,</span>
                                         <span class="n">persistence</span><span class="o">=</span><span class="n">persist_backend</span><span class="p">)</span>
        <span class="n">job_backend</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">job_backend</span><span class="p">):</span>
            <span class="c1"># Create information in the persistence backend about the</span>
            <span class="c1"># unit of work we want to complete and the factory that</span>
            <span class="c1"># can be called to create the tasks that the work unit needs</span>
            <span class="c1"># to be done.</span>
            <span class="n">lb</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">LogBook</span><span class="p">(</span><span class="s2">"post-from-</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">my_name</span><span class="p">)</span>
            <span class="n">fd</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FlowDetail</span><span class="p">(</span><span class="s2">"song-from-</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">my_name</span><span class="p">,</span>
                                   <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">())</span>
            <span class="n">lb</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">persist_backend</span><span class="o">.</span><span class="n">get_connection</span><span class="p">())</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">save_logbook</span><span class="p">(</span><span class="n">lb</span><span class="p">)</span>
            <span class="n">engines</span><span class="o">.</span><span class="n">save_factory_details</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">make_bottles</span><span class="p">,</span>
                                         <span class="p">[</span><span class="n">HOW_MANY_BOTTLES</span><span class="p">],</span> <span class="p">{},</span>
                                         <span class="n">backend</span><span class="o">=</span><span class="n">persist_backend</span><span class="p">)</span>
            <span class="c1"># Post, and be done with it!</span>
            <span class="n">jb</span> <span class="o">=</span> <span class="n">job_backend</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"song-from-</span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">my_name</span><span class="p">,</span> <span class="n">book</span><span class="o">=</span><span class="n">lb</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Posted: </span><span class="si">%s</span><span class="s2">"</span> <span class="o">%</span> <span class="n">jb</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">"Goodbye..."</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">main_local</span><span class="p">():</span>
    <span class="c1"># Run locally typically this is activating during unit testing when all</span>
    <span class="c1"># the examples are made sure to still function correctly...</span>
    <span class="k">global</span> <span class="n">TAKE_DOWN_DELAY</span>
    <span class="k">global</span> <span class="n">PASS_AROUND_DELAY</span>
    <span class="k">global</span> <span class="n">JB_CONF</span>
    <span class="c1"># Make everything go much faster (so that this finishes quickly).</span>
    <span class="n">PASS_AROUND_DELAY</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">TAKE_DOWN_DELAY</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">JB_CONF</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span> <span class="o">=</span> <span class="n">JB_CONF</span><span class="p">[</span><span class="s1">'path'</span><span class="p">]</span> <span class="o">+</span> <span class="s2">"-"</span> <span class="o">+</span> <span class="n">uuidutils</span><span class="o">.</span><span class="n">generate_uuid</span><span class="p">()</span>
    <span class="n">run_poster</span><span class="p">()</span>
    <span class="n">run_conductor</span><span class="p">(</span><span class="n">only_run_once</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">check_for_zookeeper</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"Testing for the existence of a zookeeper server...</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"Please wait....</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">closing</span><span class="p">(</span><span class="n">client</span><span class="o">.</span><span class="n">KazooClient</span><span class="p">())</span> <span class="k">as</span> <span class="n">test_client</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">test_client</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">test_client</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">timeout_exception</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"Zookeeper is needed for running this example!</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">test_client</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">True</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_for_zookeeper</span><span class="p">():</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">main_local</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">'p'</span><span class="p">,</span> <span class="s1">'c'</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"v"</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">taskflow_logging</span><span class="o">.</span><span class="n">TRACE</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'p'</span><span class="p">:</span>
            <span class="n">run_poster</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run_conductor</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">"</span><span class="si">%s</span><span class="s2"> p|c (v?)</span><span class="se">\n</span><span class="s2">"</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>
</td></tr></tbody></table></div>
</div>


          </div>
        </div>
      </div>
<div class="sphinxsidebar">
    <div class="sphinxsidebarwrapper">
            <h3><a href="https://docs.openstack.org/developer/taskflow/index.html">Table Of Contents</a></h3>
            <ul>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#">Hello world</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#passing-values-from-and-to-tasks">Passing values from and to tasks</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#using-listeners">Using listeners</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#using-listeners-to-watch-a-phone-call">Using listeners (to watch a phone call)</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#dumping-a-in-memory-backend">Dumping a in-memory backend</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#making-phone-calls">Making phone calls</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#making-phone-calls-automatically-reverting">Making phone calls (automatically reverting)</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#building-a-car">Building a car</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#iterating-over-the-alphabet-using-processes">Iterating over the alphabet (using processes)</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#watching-execution-timing">Watching execution timing</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#distance-calculator">Distance calculator</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#table-multiplier-in-parallel">Table multiplier (in parallel)</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#linear-equation-solver-explicit-dependencies">Linear equation solver (explicit dependencies)</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#linear-equation-solver-inferred-dependencies">Linear equation solver (inferred dependencies)</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#linear-equation-solver-in-parallel">Linear equation solver (in parallel)</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#creating-a-volume-in-parallel">Creating a volume (in parallel)</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#summation-mapper-s-and-reducer-in-parallel">Summation mapper(s) and reducer (in parallel)</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#sharing-a-thread-pool-executor-in-parallel">Sharing a thread pool executor (in parallel)</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#storing-emitting-a-bill">Storing &amp; emitting a bill</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#suspending-a-workflow-resuming">Suspending a workflow &amp; resuming</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#creating-a-virtual-machine-resumable">Creating a virtual machine (resumable)</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#creating-a-volume-resumable">Creating a volume (resumable)</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#running-engines-via-iteration">Running engines via iteration</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#controlling-retries-using-a-retry-controller">Controlling retries using a retry controller</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#distributed-execution-simple">Distributed execution (simple)</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#distributed-notification-simple">Distributed notification (simple)</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#distributed-mandelbrot-complex">Distributed mandelbrot (complex)</a><ul>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#output">Output</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#code">Code</a></li>
</ul>
</li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#jobboard-producer-consumer-simple">Jobboard producer/consumer (simple)</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#conductor-simulating-a-ci-pipeline">Conductor simulating a CI pipeline</a></li>
<li><a class="reference internal" href="https://docs.openstack.org/developer/taskflow/examples.html#conductor-running-99-bottles-of-beer-song-requests">Conductor running 99 bottles of beer song requests</a></li>
</ul>

  <h3>Navigation</h3>
  <ul>

    <li><a href="https://docs.openstack.org/developer/taskflow/index.html">Table Of Contents</a></li>


    <li><a href="https://docs.openstack.org/developer/taskflow/exceptions.html" title="next chapter">Next topic: Exceptions</a></li>


    <li><a href="https://docs.openstack.org/developer/taskflow/conductors.html" title="previous chapter">Previous topic: Conductors</a></li>

  </ul>

            <h3>Project Source</h3>
            <ul class="this-page-menu">
              <li><a href="http://git.openstack.org/cgit/openstack/taskflow" rel="nofollow">Project Source</a></li>
            </ul>
            <h3>This Page</h3>
            <ul class="this-page-menu">
              <li><a href="https://docs.openstack.org/developer/taskflow/_sources/examples.rst.txt" rel="nofollow">Show Source</a></li>
            </ul>
          <div id="searchbox">
            <h3>Quick search</h3>
              <form class="search" action="https://docs.openstack.org/developer/taskflow/search.html" method="get">
                <input type="text" name="q" size="18">
                <input type="submit" value="Go">
                <input type="hidden" name="check_keywords" value="yes">
                <input type="hidden" name="area" value="default">
              </form>
              <p class="searchtip" style="font-size: 90%">
              Enter search terms or a module, class or function name.
              </p>
          </div>
          <script type="text/javascript">$('#searchbox').show(0);</script>
    </div>
</div>

      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="https://docs.openstack.org/developer/taskflow/genindex.html" title="General Index" accesskey="I">index</a></li>
        <li class="right">
          <a href="https://docs.openstack.org/developer/taskflow/py-modindex.html" title="Python Module Index">modules</a> |</li>
        <li class="right">
          <a href="https://docs.openstack.org/developer/taskflow/exceptions.html" title="Exceptions" accesskey="N">next</a> |</li>
        <li class="right">
          <a href="https://docs.openstack.org/developer/taskflow/conductors.html" title="Conductors" accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="https://docs.openstack.org/developer/taskflow/index.html">taskflow 2.9.1.dev11 documentation</a> »</li> 
      </ul>
    </div>

    <div class="footer" role="contentinfo">
        © Copyright 2017, OpenStack Foundation.
      Last updated on 'Thu Mar 2 11:56:44 2017, commit 8017d7d'.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.2.
    </div>
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script><script src="./Hello world — taskflow 2.9.1.dev11 documentation_files/ga.js.下载" type="text/javascript"></script>
<script type="text/javascript">
try {
//Tracking docs.openstack.org/developer/<projectname> only
//The URL is built from the project variable in conf.py
var pageTracker = _gat._getTracker("UA-17511903-1");
pageTracker._setCookiePath("/developer/taskflow");
pageTracker._trackPageview();
} catch(err) {}</script>

  
<audio controls="controls" style="display: none;"></audio></body><style type="text/css">#yddContainer{display:block;font-family:Microsoft YaHei;position:relative;width:100%;height:100%;top:-4px;left:-4px;font-size:12px;border:1px solid}#yddTop{display:block;height:22px}#yddTopBorderlr{display:block;position:static;height:17px;padding:2px 28px;line-height:17px;font-size:12px;color:#5079bb;font-weight:bold;border-style:none solid;border-width:1px}#yddTopBorderlr .ydd-sp{position:absolute;top:2px;height:0;overflow:hidden}.ydd-icon{left:5px;width:17px;padding:0px 0px 0px 0px;padding-top:17px;background-position:-16px -44px}.ydd-close{right:5px;width:16px;padding-top:16px;background-position:left -44px}#yddKeyTitle{float:left;text-decoration:none}#yddMiddle{display:block;margin-bottom:10px}.ydd-tabs{display:block;margin:5px 0;padding:0 5px;height:18px;border-bottom:1px solid}.ydd-tab{display:block;float:left;height:18px;margin:0 5px -1px 0;padding:0 4px;line-height:18px;border:1px solid;border-bottom:none}.ydd-trans-container{display:block;line-height:160%}.ydd-trans-container a{text-decoration:none;}#yddBottom{position:absolute;bottom:0;left:0;width:100%;height:22px;line-height:22px;overflow:hidden;background-position:left -22px}.ydd-padding010{padding:0 10px}#yddWrapper{color:#252525;z-index:10001;background:url(chrome-extension://eopjamdnofihpioajgfdikhhbobonhbb/ab20.png);}#yddContainer{background:#fff;border-color:#4b7598}#yddTopBorderlr{border-color:#f0f8fc}#yddWrapper .ydd-sp{background-image:url(chrome-extension://eopjamdnofihpioajgfdikhhbobonhbb/ydd-sprite.png)}#yddWrapper a,#yddWrapper a:hover,#yddWrapper a:visited{color:#50799b}#yddWrapper .ydd-tabs{color:#959595}.ydd-tabs,.ydd-tab{background:#fff;border-color:#d5e7f3}#yddBottom{color:#363636}#yddWrapper{min-width:250px;max-width:400px;}</style></html>